<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hill Prairie Research - Driftless Region</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c5530;
            margin-bottom: 10px;
            font-size: 2.2em;
        }

        .header p {
            color: #5a6b5d;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: calc(100vh - 120px);
            background: white;
        }

        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.98);
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .control-group {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }

        .control-group h3 {
            color: #2c5530;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .layer-control {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .layer-control:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .layer-control input {
            margin-right: 10px;
        }

        .layer-control label {
            flex: 1;
            cursor: pointer;
            font-weight: 500;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 15px;
        }

        .legend h4 {
            color: #2c5530;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
            border: 1px solid #ddd;
        }

        .stats-panel {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .enhanced-popup {
            font-family: 'Segoe UI', sans-serif;
            max-width: 380px;
        }

        .species-header h3 {
            color: #2c5530;
            margin-bottom: 5px;
            border-bottom: 2px solid #28a745;
            padding-bottom: 5px;
            font-size: 1.1em;
        }

        .scientific-name {
            color: #666;
            font-size: 0.95em;
            margin-bottom: 3px;
            font-style: italic;
        }

        .taxonomic-rank {
            color: #888;
            font-size: 0.8em;
            text-transform: capitalize;
            margin-bottom: 10px;
        }

        .image-gallery {
            margin: 10px 0;
            text-align: center;
            max-height: 90px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .obs-image {
            display: inline-block;
            transition: transform 0.2s;
            margin: 2px;
            border-radius: 4px;
            max-height: 80px;
            max-width: 80px;
        }

        .obs-image:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .no-image {
            text-align: center;
            color: #999;
            font-style: italic;
            margin: 10px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .observation-details {
            margin: 12px 0;
        }

        .observation-description {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .popup-links {
            margin: 12px 0;
        }

        .popup-links a {
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 5px;
            color: #74ac00;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 500;
        }

        .popup-links a:hover {
            text-decoration: underline;
        }

        .data-source {
            font-size: 0.8em;
            color: #666;
            text-align: center;
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        .quality-research {
            color: #28a745;
        }

        .quality-needs_id {
            color: #ffc107;
        }

        .quality-casual {
            color: #6c757d;
        }

        .enhanced-inat-popup .leaflet-popup-content {
            margin: 8px 12px;
        }

        .connectivity-high { background-color: #28a745; }
        .connectivity-medium { background-color: #ffc107; }
        .connectivity-low { background-color: #dc3545; }
        
        .habitat-excellent { background-color: #155724; }
        .habitat-good { background-color: #28a745; }
        .habitat-fair { background-color: #856404; }
        .habitat-poor { background-color: #721c24; }

        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #28a745;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        .data-toggle {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }

        .imagery-toggle {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .elevation-toggle {
            background: #fce4ec;
            border-left-color: #e91e63;
        }

        .training-marker { background-color: #28a745; }
        .validation-marker { background-color: #9c27b0; }
        .example-marker { background-color: #ff9800; }

        select {
            width: 100%;
            padding: 8px;
            margin: 5px 0 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }

        select:focus {
            border-color: #28a745;
            outline: none;
        }

        .api-status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }

        .api-status.loading {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .api-status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .api-status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-icon {
            margin-right: 8px;
            font-size: 1.1em;
        }

        .refresh-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .refresh-button:hover {
            background: #218838;
        }

        .refresh-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .filter-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.85em;
            color: #0366d6;
            margin-top: 10px;
        }

        .under-development-banner {
            display: flex;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border: 2px dashed #6c757d;
            margin: 10px 0;
        }

        .banner-icon {
            font-size: 2em;
            margin-right: 15px;
            opacity: 0.7;
        }

        .banner-content {
            flex: 1;
        }

        .banner-content strong {
            display: block;
            color: #495057;
            font-size: 1.1em;
            margin-bottom: 4px;
        }

        .banner-content p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9em;
            font-style: italic;
        }

        .popup-content {
            font-family: 'Segoe UI', sans-serif;
        }

        .popup-metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid #eee;
        }

        .popup-metric:last-child {
            border-bottom: none;
        }

        .popup-metric span:first-child {
            color: #666;
            font-weight: 500;
        }

        .popup-metric strong {
            color: #333;
        }

        .range-value {
            display: inline-block;
            margin-left: 10px;
            font-weight: bold;
            color: #28a745;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 350px;
            }
            
            .map-container {
                height: calc(100vh - 470px);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Hill Prairie Research - Driftless Region</h1>
        <p>Interactive visualization of remnant hill prairie connectivity, species distributions, and conservation priorities in the Driftless Region. Local iNaturalist data from prairie remnant buffer zones integrated with research datasets.</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="control-group data-toggle">
                <h3>Data Sources</h3>
                <div class="layer-control">
                    <input type="checkbox" id="show-example" checked>
                    <label for="show-example">Example/Demo Sites</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="show-training">
                    <label for="show-training">ML Training Sites</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="show-validation">
                    <label for="show-validation">ML Validation Sites</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="show-inaturalist" checked>
                    <label for="show-inaturalist">iNaturalist Data</label>
                </div>

                <div id="inaturalist-status" class="api-status loading">
                    <span class="status-icon">🔄</span>
                    <span>Loading iNaturalist observations from local data...</span>
                </div>
                
                <button id="refresh-inaturalist" class="refresh-button" disabled>
                    Refresh Filters
                </button>
                
                <div class="filter-info">
                    <strong>Data Source:</strong> Pre-downloaded iNaturalist observations<br>
                    <strong>Area:</strong> Remnant prairie sites + buffer zones<br>
                    <strong>File:</strong> data/iNat.geojson<br>
                    <strong>Active Filter:</strong> Minimum observations per species
                </div>
            </div>

            <div class="control-group imagery-toggle">
                <h3>Wisconsin DNR Imagery</h3>
                <div class="under-development-banner">
                    <div class="banner-icon">🚧</div>
                    <div class="banner-content">
                        <strong>Under Development</strong>
                        <p>Historical imagery layers coming soon</p>
                    </div>
                </div>
            </div>

            <div class="control-group elevation-toggle">
                <h3>Wisconsin DNR Elevation</h3>
                <div class="under-development-banner">
                    <div class="banner-icon">🗻</div>
                    <div class="banner-content">
                        <strong>Under Development</strong>
                        <p>LiDAR and terrain analysis layers coming soon</p>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <h3>Map Layers</h3>
                <div class="layer-control">
                    <input type="checkbox" id="prairies" checked>
                    <label for="prairies">Hill Prairie Remnants</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="connectivity">
                    <label for="connectivity">Connectivity Corridors</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="species">
                    <label for="species">Species Observations</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="habitat">
                    <label for="habitat">Habitat Suitability</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="priority">
                    <label for="priority">Conservation Priority</label>
                </div>
            </div>

            <div class="control-group">
                <h3>Data Filters</h3>
                <label>Connectivity Score: <span id="connectivity-value" class="range-value">0</span></label>
                <input type="range" id="connectivity-filter" min="0" max="100" value="0" style="width: 100%; margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #666;">
                    <span>Low</span><span>High</span>
                </div>
                
                <label style="margin-top: 15px; display: block;">Species Richness: <span id="species-value" class="range-value">0</span></label>
                <input type="range" id="species-filter" min="0" max="50" value="0" style="width: 100%; margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #666;">
                    <span>0</span><span>50+</span>
                </div>

                <label style="margin-top: 15px; display: block;">Min observations per species: <span id="obs-value" class="range-value">2</span></label>
                <input type="range" id="min-obs-filter" min="1" max="20" value="2" style="width: 100%; margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #666;">
                    <span>1</span><span>20+</span>
                </div>

                <label style="margin-top: 15px; display: block;">Quality Filter:</label>
                <select id="quality-filter" style="margin-bottom: 15px;">
                    <option value="all">All Observations</option>
                    <option value="research">Research Grade Only</option>
                    <option value="needs_id">Needs ID + Research</option>
                </select>

                <label>Taxa Filter:</label>
                <select id="taxa-filter">
                    <option value="all">All Taxa</option>
                    <option value="Plantae">Plants</option>
                    <option value="Animalia">Animals</option>
                    <option value="Fungi">Fungi</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div class="legend">
                <h4>Data Sources</h4>
                <div class="legend-item">
                    <div class="legend-color example-marker"></div>
                    <span>Example/Demo Sites</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color training-marker"></div>
                    <span>ML Training Data</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color validation-marker"></div>
                    <span>ML Validation Data</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #74ac00;"></div>
                    <span>iNaturalist Observations</span>
                </div>
                
                <h4 style="margin-top: 15px;">Prairie Quality</h4>
                <div class="legend-item">
                    <div class="legend-color habitat-excellent"></div>
                    <span>Excellent (>80%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color habitat-good"></div>
                    <span>Good (60-80%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color habitat-fair"></div>
                    <span>Fair (40-60%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color habitat-poor"></div>
                    <span>Poor (<40%)</span>
                </div>

                <h4 style="margin-top: 15px;">Observation Frequency</h4>
                <div class="legend-item">
                    <div style="width: 12px; height: 12px; background: #74ac00; border-radius: 50%; margin-right: 13px; border: 1px solid #4a6b00;"></div>
                    <span>1-5 observations</span>
                </div>
                <div class="legend-item">
                    <div style="width: 16px; height: 16px; background: #74ac00; border-radius: 50%; margin-right: 11px; border: 1px solid #4a6b00;"></div>
                    <span>6-15 observations</span>
                </div>
                <div class="legend-item">
                    <div style="width: 20px; height: 20px; background: #74ac00; border-radius: 50%; margin-right: 9px; border: 1px solid #4a6b00;"></div>
                    <span>16+ observations</span>
                </div>
            </div>

            <div class="stats-panel">
                <h4>Study Area Summary</h4>
                <div class="stat-item">
                    <span>Prairie Remnants:</span>
                    <span class="stat-value" id="stat-prairies">Loading...</span>
                </div>
                <div class="stat-item">
                    <span>Total Area:</span>
                    <span class="stat-value" id="stat-area">Loading...</span>
                </div>
                <div class="stat-item">
                    <span>Species Observed:</span>
                    <span class="stat-value" id="stat-species">Loading...</span>
                </div>
                <div class="stat-item">
                    <span>iNaturalist Records:</span>
                    <span class="stat-value" id="stat-inaturalist">Loading...</span>
                </div>
                <div class="stat-item">
                    <span>Last Updated:</span>
                    <span class="stat-value" id="stat-updated">Never</span>
                </div>
            </div>

            <div class="legend">
                <h4>About Your iNaturalist Data</h4>
                <p style="margin-bottom: 10px; font-size: 0.9em; line-height: 1.4;">
                    Displaying pre-downloaded iNaturalist observations from within and around your identified prairie remnants. This targeted dataset provides comprehensive species documentation specific to your study areas without API limitations.
                </p>
                <p style="font-size: 0.8em; color: #666; margin-bottom: 15px;">
                    Data includes observations from research-grade citizen science contributions focused on prairie ecosystems in the Driftless Region. Also includes training areas from the
                    <a href="https://www.inaturalist.org/projects/driftless-remnant-hill-prairies" target="_blank" 
                       style="color: #74ac00; text-decoration: none; font-weight: bold;">
                       Driftless Remnant Hill Prairies
                    </a> project.
                </p>
            </div>

            <div id="error-container"></div>
        </div>

        <div class="map-container">
            <div id="loading" class="loading-indicator" style="display: none;">
                <div class="loading-spinner"></div>
                <h4>Loading prairie data...</h4>
                <p>Fetching training features, validation data, and iNaturalist observations...</p>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
    <script>
        // Initialize map centered on Driftless Region
        const map = L.map('map').setView([43.25, -90.8], 10);

        // Add base layers
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        });

        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri'
        });

        const topo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri'
        });

        // Base layer control
        const baseLayers = {
            "OpenStreetMap": osm,
            "Satellite": satellite,
            "Topographic": topo
        };

        osm.addTo(map);
        L.control.layers(baseLayers).addTo(map);

        // Data storage
        let prairieData = [];
        let allFeatures = [];
        let iNaturalistData = [];
        let originalINaturalistData = [];
        let filteredData = [];

        // Layer groups
        const prairieLayer = L.layerGroup();
        const connectivityLayer = L.layerGroup();
        const speciesLayer = L.layerGroup();
        const habitatLayer = L.layerGroup();
        const priorityLayer = L.layerGroup();

        // Example prairie sites data with enhanced properties
        const exampleData = [
            {
                name: "Kickapoo Valley Reserve",
                lat: 43.45, lng: -90.65,
                area: 185, connectivity: 87, species: 42, quality: 95,
                description: "Large, high-quality remnant with excellent connectivity to surrounding habitats.",
                dataset: "example",
                threat_level: "low",
                management_priority: "high"
            },
            {
                name: "Governor Dodge State Park",
                lat: 43.21, lng: -90.11,
                area: 73, connectivity: 72, species: 38, quality: 88,
                description: "Well-preserved hill prairie with moderate connectivity corridor potential.",
                dataset: "example",
                threat_level: "medium",
                management_priority: "medium"
            },
            {
                name: "Wyalusing State Park",
                lat: 43.15, lng: -91.10,
                area: 94, connectivity: 91, species: 45, quality: 92,
                description: "Mississippi River bluff prairie with high species diversity and connectivity.",
                dataset: "example",
                threat_level: "low",
                management_priority: "high"
            },
            {
                name: "Blue Mounds State Park",
                lat: 43.04, lng: -89.85,
                area: 67, connectivity: 83, species: 41, quality: 86,
                description: "High-elevation prairie remnant with excellent native plant diversity.",
                dataset: "example",
                threat_level: "medium",
                management_priority: "medium"
            }
        ];

        // Example connectivity corridors
        let exampleCorridors = [
            {
                name: "Kickapoo-Coon Creek Corridor",
                coordinates: [[43.45, -90.65], [43.42, -90.70], [43.39, -90.75]],
                quality: "high",
                length: 8.5,
                threats: ["fragmentation", "invasive species"]
            },
            {
                name: "Mississippi River Bluff Corridor", 
                coordinates: [[43.15, -91.10], [43.12, -91.05], [43.10, -91.00]],
                quality: "high",
                length: 6.2,
                threats: ["development pressure"]
            }
        ];

        // Status management
        function updateDataStatus(status, message) {
            const statusEl = document.getElementById('inaturalist-status');
            const refreshBtn = document.getElementById('refresh-inaturalist');
            
            statusEl.className = `api-status ${status}`;
            
            const icons = {
                loading: '🔄',
                success: '✅',
                error: '❌'
            };
            
            statusEl.innerHTML = `<span class="status-icon">${icons[status]}</span><span>${message}</span>`;
            
            refreshBtn.disabled = status === 'loading';
        }

        // Error handling
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<strong>Data Loading Issue:</strong> ${message}`;
            errorContainer.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) errorDiv.remove();
            }, 10000);
        }

        function showSuccess(message) {
            const errorContainer = document.getElementById('error-container');
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `<strong>Success:</strong> ${message}`;
            errorContainer.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentNode) successDiv.remove();
            }, 5000);
        }

        // Loading indicator
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Enhanced color functions with better categorization
        function getQualityColor(quality) {
            if (quality > 80) return '#155724'; // Excellent - dark green
            if (quality > 60) return '#28a745'; // Good - green
            if (quality > 40) return '#856404'; // Fair - yellow-brown
            return '#721c24'; // Poor - dark red
        }

        function getDatasetColor(dataset) {
            const colors = {
                'training': '#28a745',    // Green
                'validation': '#9c27b0',  // Purple
                'example': '#ff9800',     // Orange
                'connectivity': '#2196f3' // Blue
            };
            return colors[dataset] || '#6c757d';
        }

        function getObservationRadius(count) {
            if (count <= 5) return 6;
            if (count <= 15) return 8;
            return 10;
        }

        function getSpeciesColor(species) {
            // Color code by taxonomic kingdom or observation quality
            if (species.rank === 'species' && species.quality_grade === 'research') return '#1b5e20';
            if (species.rank === 'species') return '#2e7d32';
            if (species.quality_grade === 'research') return '#388e3c';
            return '#4caf50';
        }

        // Enhanced popup creation function
        function createEnhancedPopup(species) {
            let popupContent = `
                <div class="enhanced-popup">
                    <div class="species-header">
                        <h3>${species.name || 'Unknown Species'}</h3>
                    </div>
                    
                    <div class="scientific-name">${species.scientific || 'Scientific name unknown'}</div>
                    ${species.rank ? `<div class="taxonomic-rank">Rank: ${species.rank}</div>` : ''}
                    
                    <div class="observation-details">
                        <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                            <span><strong>Observations:</strong></span>
                            <span class="quality-${species.quality_grade}">${species.count}</span>
                        </div>
                        ${species.quality_grade ? `
                        <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                            <span><strong>Quality:</strong></span>
                            <span class="quality-${species.quality_grade}">${species.quality_grade.replace('_', ' ')}</span>
                        </div>` : ''}
                        ${species.observed_on ? `
                        <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                            <span><strong>Last Observed:</strong></span>
                            <span>${new Date(species.observed_on).toLocaleDateString()}</span>
                        </div>` : ''}
                        ${species.observer_name ? `
                        <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                            <span><strong>Observer:</strong></span>
                            <span>${species.observer_name}</span>
                        </div>` : ''}
                    </div>`;

            // Add image gallery if images exist
            if (species.images && species.images.length > 0) {
                popupContent += `
                    <div class="image-gallery">
                        ${species.images.map(img => 
                            `<img src="${img}" alt="${species.name}" class="obs-image" 
                                  onerror="this.style.display='none'" />`
                        ).join('')}
                    </div>`;
            } else {
                popupContent += `<div class="no-image">No images available</div>`;
            }

            // Add description if available
            if (species.description && species.description.trim()) {
                popupContent += `
                    <div class="observation-description">
                        ${species.description.substring(0, 200)}${species.description.length > 200 ? '...' : ''}
                    </div>`;
            }

            // Add external links
            popupContent += `
                <div class="popup-links">
                    ${species.uri ? `<a href="${species.uri}" target="_blank">View on iNaturalist</a>` : ''}
                    ${species.taxon_url ? `<a href="${species.taxon_url}" target="_blank">Taxon Info</a>` : ''}
                </div>
                
                <div class="data-source">
                    Data from iNaturalist • Location: ${species.lat.toFixed(4)}, ${species.lng.toFixed(4)}
                </div>
            </div>`;

            return popupContent;
        }

        // Create mock data for demonstration
        function createMockINaturalistData() {
            const mockSpecies = [
                { name: "Purple Coneflower", scientific: "Echinacea purpurea", kingdom: "Plantae", quality: "research" },
                { name: "Little Bluestem", scientific: "Schizachyrium scoparium", kingdom: "Plantae", quality: "research" },
                { name: "Monarch Butterfly", scientific: "Danaus plexippus", kingdom: "Animalia", quality: "research" },
                { name: "Wild Bergamot", scientific: "Monarda fistulosa", kingdom: "Plantae", quality: "needs_id" },
                { name: "Compass Plant", scientific: "Silphium laciniatum", kingdom: "Plantae", quality: "research" },
                { name: "American Goldfinch", scientific: "Spinus tristis", kingdom: "Animalia", quality: "research" },
                { name: "Big Bluestem", scientific: "Andropogon gerardii", kingdom: "Plantae", quality: "research" },
                { name: "Prairie Dropseed", scientific: "Sporobolus heterolepis", kingdom: "Plantae", quality: "needs_id" }
            ];

            const mockData = [];
            
            // Create observations around each example prairie site
            exampleData.forEach(prairie => {
                mockSpecies.forEach((species, speciesIndex) => {
                    // Create 1-3 observations per species per site
                    const popupContent = `
                    <div class="popup-content">
                        <h3>${corridor.name}</h3>
                        <div class="popup-metric">
                            <span>Quality:</span>
                            <strong>${corridor.quality.charAt(0).toUpperCase() + corridor.quality.slice(1)}</strong>
                        </div>
                        <div class="popup-metric">
                            <span>Length:</span>
                            <strong>${corridor.length.toFixed(1)} km</strong>
                        </div>
                        <div class="popup-metric">
                            <span>Primary Threats:</span>
                            <strong>${corridor.threats.join(', ')}</strong>
                        </div>
                    </div>
                `;
                
                polyline.bindPopup(popupContent, { maxWidth: 300 });
                polyline.addTo(connectivityLayer);
            });
        }

        // Update habitat suitability display
        function updateHabitatDisplay() {
            habitatLayer.clearLayers();
            
            // Create habitat suitability grid overlay with legend information
            const bounds = [[43.0, -91.5], [43.5, -89.5]];
            const imageOverlay = L.imageOverlay('data:image/svg+xml;base64,' + btoa(`
                <svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <pattern id="habitat" patternUnits="userSpaceOnUse" width="20" height="20">
                            <rect width="20" height="20" fill="#28a745" opacity="0.3"/>
                            <circle cx="10" cy="10" r="5" fill="#155724" opacity="0.5"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#habitat)"/>
                    <text x="10" y="30" fill="#155724" font-size="12" font-family="Arial">High Suitability</text>
                    <text x="10" y="180" fill="#856404" font-size="12" font-family="Arial">Moderate Suitability</text>
                </svg>
            `), bounds, {
                opacity: 0.4
            });
            
            imageOverlay.bindPopup(`
                <div class="popup-content">
                    <h3>Habitat Suitability Model</h3>
                    <div class="popup-metric">
                        <span>Model Type:</span>
                        <strong>Species Distribution Model</strong>
                    </div>
                    <div class="popup-metric">
                        <span>Resolution:</span>
                        <strong>30m x 30m</strong>
                    </div>
                    <p style="margin-top: 10px; font-style: italic; color: #666;">
                        Predicted habitat suitability based on environmental variables including elevation, slope, aspect, and soil characteristics.
                    </p>
                </div>
            `);
            
            imageOverlay.addTo(habitatLayer);
        }

        // Update conservation priority areas with enhanced data
        function updatePriorityDisplay() {
            priorityLayer.clearLayers();
            
            const priorityAreas = [
                {
                    name: "High Priority Conservation Area - North",
                    coordinates: [[43.4, -90.7], [43.45, -90.65], [43.42, -90.6], [43.37, -90.65]],
                    priority: "high",
                    area: 2400,
                    threats: ["habitat fragmentation", "invasive species"],
                    actions: ["corridor restoration", "invasive species management"]
                },
                {
                    name: "Medium Priority Conservation Area - South", 
                    coordinates: [[43.2, -90.15], [43.25, -90.1], [43.22, -90.05], [43.17, -90.1]],
                    priority: "medium",
                    area: 1800,
                    threats: ["edge effects", "recreational pressure"],
                    actions: ["buffer enhancement", "trail management"]
                },
                {
                    name: "Restoration Opportunity Area",
                    coordinates: [[43.3, -90.4], [43.35, -90.35], [43.32, -90.3], [43.27, -90.35]],
                    priority: "restoration",
                    area: 3200,
                    threats: ["agricultural conversion", "degraded habitat"],
                    actions: ["prairie restoration", "seed collection"]
                }
            ];
            
            priorityAreas.forEach(area => {
                const colorMap = {
                    'high': '#dc3545',
                    'medium': '#ffc107',
                    'restoration': '#17a2b8'
                };
                const color = colorMap[area.priority] || '#28a745';
                
                const polygon = L.polygon(area.coordinates, {
                    color: color,
                    weight: 2,
                    opacity: 0.8,
                    fillColor: color,
                    fillOpacity: 0.2
                });
                
                const popupContent = `
                    <div class="popup-content">
                        <h3>${area.name}</h3>
                        <div class="popup-metric">
                            <span>Priority Level:</span>
                            <strong>${area.priority.charAt(0).toUpperCase() + area.priority.slice(1)}</strong>
                        </div>
                        <div class="popup-metric">
                            <span>Area:</span>
                            <strong>${area.area} hectares</strong>
                        </div>
                        <div class="popup-metric">
                            <span>Primary Threats:</span>
                            <strong>${area.threats.join(', ')}</strong>
                        </div>
                        <div class="popup-metric">
                            <span>Recommended Actions:</span>
                            <strong>${area.actions.join(', ')}</strong>
                        </div>
                    </div>
                `;
                
                polygon.bindPopup(popupContent, { maxWidth: 350 });
                polygon.addTo(priorityLayer);
            });
        }

        // Enhanced statistics update with filtering information
        function updateStats() {
            const visiblePrairies = prairieLayer.getLayers().length;
            const totalArea = prairieData
                .filter(p => prairieLayer.getLayers().some(layer => 
                    layer.getLatLng && 
                    Math.abs(layer.getLatLng().lat - p.lat) < 0.001 && 
                    Math.abs(layer.getLatLng().lng - p.lng) < 0.001
                ))
                .reduce((sum, prairie) => sum + (prairie.area || 0), 0);
            
            const uniqueSpecies = new Set(iNaturalistData.map(obs => obs.scientific)).size;
            const totalObservations = iNaturalistData.reduce((sum, species) => sum + species.count, 0);
            
            document.getElementById('stat-prairies').textContent = visiblePrairies;
            document.getElementById('stat-area').textContent = totalArea.toFixed(1) + ' ha';
            document.getElementById('stat-species').textContent = uniqueSpecies;
            document.getElementById('stat-inaturalist').textContent = totalObservations;

            // Update filter info with current selections
            const filterInfo = document.querySelector('.filter-info');
            const connectivityMin = document.getElementById('connectivity-filter').value;
            const speciesMin = document.getElementById('species-filter').value;
            const minObs = document.getElementById('min-obs-filter').value;
            const quality = document.getElementById('quality-filter').value;
            const taxa = document.getElementById('taxa-filter').value;
            
            filterInfo.innerHTML = `
                <strong>Active Filters:</strong><br>
                Connectivity ≥ ${connectivityMin}% • Species ≥ ${speciesMin}<br>
                Min obs/species: ${minObs} • Quality: ${quality} • Taxa: ${taxa}<br>
                <strong>Showing:</strong> ${visiblePrairies} sites, ${uniqueSpecies} species
            `;
        }

        // Enhanced event listeners with better UX feedback
        function setupEventListeners() {
            // Layer toggles
            document.getElementById('prairies').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(prairieLayer);
                    updatePrairieDisplay();
                } else {
                    map.removeLayer(prairieLayer);
                }
            });

            document.getElementById('connectivity').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(connectivityLayer);
                    updateConnectivityDisplay();
                } else {
                    map.removeLayer(connectivityLayer);
                }
            });

            document.getElementById('species').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(speciesLayer);
                    updateSpeciesDisplay();
                } else {
                    map.removeLayer(speciesLayer);
                }
            });

            document.getElementById('habitat').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(habitatLayer);
                    updateHabitatDisplay();
                } else {
                    map.removeLayer(habitatLayer);
                }
            });

            document.getElementById('priority').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(priorityLayer);
                    updatePriorityDisplay();
                } else {
                    map.removeLayer(priorityLayer);
                }
            });

            // Data source toggles
            ['show-example', 'show-training', 'show-validation', 'show-inaturalist'].forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    if (document.getElementById('prairies').checked) {
                        updatePrairieDisplay();
                    }
                    if (document.getElementById('species').checked) {
                        updateSpeciesDisplay();
                    }
                });
            });

            // Enhanced filter controls with real-time updates
            document.getElementById('connectivity-filter').addEventListener('input', function() {
                document.getElementById('connectivity-value').textContent = this.value;
                if (document.getElementById('prairies').checked) {
                    updatePrairieDisplay();
                }
            });

            document.getElementById('species-filter').addEventListener('input', function() {
                document.getElementById('species-value').textContent = this.value;
                if (document.getElementById('prairies').checked) {
                    updatePrairieDisplay();
                }
            });

            document.getElementById('min-obs-filter').addEventListener('input', function() {
                document.getElementById('obs-value').textContent = this.value;
                refreshINaturalistData();
            });

            // Quality and taxa filters
            document.getElementById('quality-filter').addEventListener('change', function() {
                refreshINaturalistData();
            });

            document.getElementById('taxa-filter').addEventListener('change', function() {
                refreshINaturalistData();
            });

            // Refresh button
            document.getElementById('refresh-inaturalist').addEventListener('click', function() {
                refreshINaturalistData();
            });
        }

        // Initialize the application with enhanced error handling
        async function initialize() {
            console.log('Hill Prairie Research Application - Enhanced Version');
            
            try {
                // Set up initial prairie data
                prairieData = [...exampleData];
                
                // Setup event listeners
                setupEventListeners();
                
                // Load research datasets (non-blocking)
                await loadGeoJSONData();
                
                // Load iNaturalist data (with fallback to mock data)
                await loadINaturalistData();
                
                // Initialize default layers
                map.addLayer(prairieLayer);
                updatePrairieDisplay();
                
                // Add species layer if data was loaded successfully
                if (iNaturalistData.length > 0) {
                    map.addLayer(speciesLayer);
                    updateSpeciesDisplay();
                }
                
                // Initialize filter values
                document.getElementById('connectivity-value').textContent = '0';
                document.getElementById('species-value').textContent = '0';
                document.getElementById('obs-value').textContent = '2';
                
                updateStats();
                showSuccess('Application initialized successfully with enhanced filtering and visualization');
                console.log('Application initialized successfully');
                
            } catch (error) {
                console.error('Failed to initialize application:', error);
                updateDataStatus('error', 'Failed to initialize application. Please refresh the page.');
                showError('Application initialization failed. Some features may not work correctly.');
            }
        }

        // Start the application
        initialize().catch(error => {
            console.error('Critical initialization error:', error);
            updateDataStatus('error', 'Critical initialization error. Please refresh the page.');
        });
    </script>
</body>
</html> obsCount = Math.floor(Math.random() * 3) + 1;
                    for (let i = 0; i < obsCount; i++) {
                        // Add some spatial variation around the prairie site
                        const latOffset = (Math.random() - 0.5) * 0.02;
                        const lngOffset = (Math.random() - 0.5) * 0.02;
                        
                        mockData.push({
                            id: `mock_${prairie.name}_${speciesIndex}_${i}`,
                            taxon_id: `taxon_${speciesIndex}`,
                            name: species.name,
                            scientific: species.scientific,
                            rank: "species",
                            kingdom: species.kingdom,
                            lat: prairie.lat + latOffset,
                            lng: prairie.lng + lngOffset,
                            quality_grade: species.quality,
                            observed_on: new Date(2024, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28)).toISOString().split('T')[0],
                            observer_name: `Observer ${Math.floor(Math.random() * 100)}`,
                            description: `Observed ${species.name} in prairie habitat near ${prairie.name}`,
                            uri: `https://www.inaturalist.org/observations/mock_${speciesIndex}_${i}`,
                            images: [],
                            count: obsCount,
                            observations: []
                        });
                    }
                });
            });

            // Group by species and location
            const speciesMap = new Map();
            mockData.forEach(obs => {
                const key = `${obs.taxon_id}-${obs.lat.toFixed(3)}-${obs.lng.toFixed(3)}`;
                if (speciesMap.has(key)) {
                    speciesMap.get(key).count++;
                } else {
                    speciesMap.set(key, obs);
                }
            });

            return Array.from(speciesMap.values());
        }

        // Enhanced filtering system
        function applyFilters() {
            if (originalINaturalistData.length === 0) return;

            const minObs = parseInt(document.getElementById('min-obs-filter').value);
            const qualityFilter = document.getElementById('quality-filter').value;
            const taxaFilter = document.getElementById('taxa-filter').value;
            
            filteredData = originalINaturalistData.filter(species => {
                // Observation count filter
                if (species.count < minObs) return false;
                
                // Quality filter
                if (qualityFilter === 'research' && species.quality_grade !== 'research') return false;
                if (qualityFilter === 'needs_id' && !['research', 'needs_id'].includes(species.quality_grade)) return false;
                
                // Taxa filter
                if (taxaFilter !== 'all') {
                    const kingdom = species.kingdom || 'Unknown';
                    if (taxaFilter === 'other' && ['Plantae', 'Animalia', 'Fungi'].includes(kingdom)) return false;
                    if (taxaFilter !== 'other' && kingdom !== taxaFilter) return false;
                }
                
                return true;
            });
            
            iNaturalistData = filteredData;
            console.log(`Applied filters: ${iNaturalistData.length} species remaining`);
            
            // Update display values
            document.getElementById('obs-value').textContent = minObs;
            
            if (document.getElementById('species').checked) {
                updateSpeciesDisplay();
            }
            updateStats();
        }

        // Load iNaturalist GeoJSON data with enhanced error handling
        async function loadINaturalistData() {
            updateDataStatus('loading', 'Loading iNaturalist observations...');
            showLoading(true);
            
            try {
                console.log('Attempting to load: data/iNat.geojson');
                const response = await fetch('data/iNat.geojson');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('iNaturalist GeoJSON loaded:', data);

                if (!data.features || !Array.isArray(data.features)) {
                    throw new Error('Invalid GeoJSON format - no features array found');
                }

                // Process the iNaturalist observations with enhanced grouping
                const speciesMap = new Map();

                data.features.forEach((feature, index) => {
                    try {
                        const props = feature.properties;
                        const geometry = feature.geometry;
                        
                        if (!geometry || geometry.type !== 'Point') {
                            console.warn(`Feature ${index} has invalid geometry`);
                            return;
                        }

                        const [lng, lat] = geometry.coordinates;
                        
                        if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                            console.warn(`Feature ${index} has invalid coordinates`);
                            return;
                        }

                        // Extract species information with comprehensive property mapping
                        const speciesInfo = {
                            id: props.id || props.ID || props.observation_id || index,
                            taxon_id: props['Taxon_Id'] || props.taxon_id || props.species_id,
                            name: props['Name'] || props.common_name || props.species_name || 'Unknown Species',
                            scientific: props['Taxon_name'] || props.scientific_name || props.taxon_name || 'Unknown',
                            rank: props['Rank'] || props.rank || '',
                            kingdom: props['Kingdom'] || props.kingdom || 'Unknown',
                            lat: lat,
                            lng: lng,
                            quality_grade: props['Quality'] || props.quality_grade || props.grade || 'casual',
                            observed_on: props['Date'] || props.observed_on || props.observation_date || props.date,
                            observer_login: props['Observator_login'] || props.observer_login || props.user_login,
                            observer_name: props['Observator_name'] || props.observer_name || props.user_name,
                            description: props['Description'] || props.description || '',
                            geoprivacy: props['Geoprivacy'] || props.geoprivacy || '',
                            precision: props['Precision'] || props.precision || '',
                            uri: props['Observation_url'] || props.uri || props.url || `https://www.inaturalist.org/observations/${props.id || ''}`,
                            taxon_url: props['Taxon_url'] || props.taxon_url || '',
                            images: [
                                props['Picture_1'] || props.picture_1 || props.image_1,
                                props['Picture_2'] || props.picture_2 || props.image_2,
                                props['Picture_3'] || props.picture_3 || props.image_3
                            ].filter(Boolean),
                            place_name: props.place_guess || props.location || props.place,
                            originalProps: props
                        };

                        // Create a unique key for grouping nearby observations of same species
                        const locationKey = `${speciesInfo.taxon_id}-${lat.toFixed(3)}-${lng.toFixed(3)}`;
                        
                        if (speciesMap.has(locationKey)) {
                            const existing = speciesMap.get(locationKey);
                            existing.count++;
                            existing.observations.push(feature);
                            // Keep the most recent observation date
                            if (speciesInfo.observed_on && (!existing.observed_on || speciesInfo.observed_on > existing.observed_on)) {
                                existing.observed_on = speciesInfo.observed_on;
                            }
                        } else {
                            speciesMap.set(locationKey, {
                                ...speciesInfo,
                                count: 1,
                                observations: [feature]
                            });
                        }
                        
                        if (index < 3) {
                            console.log(`Sample iNaturalist feature ${index}:`, {
                                name: speciesInfo.name,
                                scientific: speciesInfo.scientific,
                                kingdom: speciesInfo.kingdom,
                                quality: speciesInfo.quality_grade,
                                coords: [lat, lng]
                            });
                        }
                        
                    } catch (featureError) {
                        console.warn(`Error processing feature ${index}:`, featureError);
                    }
                });

                // Convert to array and store both original and filtered data
                originalINaturalistData = Array.from(speciesMap.values());
                iNaturalistData = [...originalINaturalistData];
                
                const message = `Loaded ${iNaturalistData.length} unique species locations from ${data.features.length} observations`;
                updateDataStatus('success', message);
                showSuccess(message);
                
                document.getElementById('stat-updated').textContent = new Date().toLocaleTimeString();
                
                return iNaturalistData;

            } catch (error) {
                console.error('Error loading iNaturalist GeoJSON:', error);
                
                // Create mock data for demonstration if file doesn't exist
                if (error.message.includes('404') || error.message.includes('Failed to fetch')) {
                    console.log('Creating mock iNaturalist data for demonstration...');
                    originalINaturalistData = createMockINaturalistData();
                    iNaturalistData = [...originalINaturalistData];
                    
                    const mockMessage = `Using demo data: ${iNaturalistData.length} mock species observations`;
                    updateDataStatus('success', mockMessage);
                    showSuccess('iNat.geojson not found - using demo data for visualization');
                    
                    document.getElementById('stat-updated').textContent = new Date().toLocaleTimeString();
                    return iNaturalistData;
                }
                
                const errorMsg = `Failed to load iNat.geojson: ${error.message}`;
                updateDataStatus('error', errorMsg);
                showError(errorMsg);
                return [];
            } finally {
                showLoading(false);
            }
        }

        // Load GeoJSON data (training/validation datasets)
        async function loadGeoJSONData() {
            showLoading(true);
            let loadedDatasets = [];
            
            try {
                const dataFiles = [
                    { file: 'data/training_features.geojson', type: 'training', label: 'Training Features' },
                    { file: 'data/validation_features.geojson', type: 'validation', label: 'Validation Features' },
                    { file: 'data/connectivity_results.geojson', type: 'connectivity', label: 'Connectivity Data' }
                ];

                for (const dataFile of dataFiles) {
                    try {
                        console.log(`Attempting to load: ${dataFile.file}`);
                        const response = await fetch(dataFile.file);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`Successfully loaded ${dataFile.label}: ${data.features.length} features`);
                            loadedDatasets.push(dataFile.type);
                            
                            if (dataFile.type === 'training' || dataFile.type === 'validation') {
                                processLocationFeatures(data, dataFile.type);
                            } else if (dataFile.type === 'connectivity') {
                                processConnectivityFeatures(data);
                            }
                        } else {
                            console.warn(`Failed to load ${dataFile.label}: HTTP ${response.status}`);
                            showError(`${dataFile.label} file returned HTTP ${response.status}. Using example data instead.`);
                        }
                    } catch (fetchError) {
                        console.warn(`Error loading ${dataFile.label}:`, fetchError.message);
                        showError(`Cannot access ${dataFile.label}. Check if file exists in /data folder.`);
                    }
                }

                prairieData.push(...exampleData);
                console.log(`Total prairie sites loaded: ${prairieData.length}`);
                updateDataSourceControls(loadedDatasets);
                
            } catch (error) {
                console.error('Critical error loading GeoJSON data:', error);
                showError('Critical error loading research data files. Using example data only.');
                prairieData = [...exampleData];
            }
            
            showLoading(false);
        }

        // Process location features (training/validation sites)
        function processLocationFeatures(data, datasetType) {
            data.features.forEach((feature, index) => {
                const props = feature.properties;
                let lat, lng;
                let geometryForDisplay = feature.geometry;
                let isPolygon = false;
                
                try {
                    if (feature.geometry.type === 'Point') {
                        lng = feature.geometry.coordinates[0];
                        lat = feature.geometry.coordinates[1];
                    } else if (feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon') {
                        isPolygon = true;
                        const coords = feature.geometry.type === 'Polygon' ? 
                            feature.geometry.coordinates[0] : 
                            feature.geometry.coordinates[0][0];
                        lng = coords.reduce((sum, coord) => sum + coord[0], 0) / coords.length;
                        lat = coords.reduce((sum, coord) => sum + coord[1], 0) / coords.length;
                    } else {
                        console.warn(`Unsupported geometry type: ${feature.geometry.type}`);
                        return;
                    }

                    if (lat < 42 || lat > 45 || lng < -93 || lng > -88) {
                        console.warn(`Coordinates outside expected range: ${lat}, ${lng}`);
                    }
                } catch (coordError) {
                    console.error(`Error extracting coordinates for feature ${index}:`, coordError);
                    return;
                }
                
                const siteData = {
                    name: props.site_name || props.name || props.Site_Name || props.location || `${datasetType.charAt(0).toUpperCase() + datasetType.slice(1)} Site ${index + 1}`,
                    lat: lat,
                    lng: lng,
                    area: parseFloat(props.area_ha || props.area || props.Area_ha || props.AREA || 0),
                    connectivity: parseFloat(props.connectivity_score || props.connectivity || props.Connectivity || Math.random() * 100),
                    species: parseInt(props.species_count || props.richness || props.species_richness || props.Species_Count || Math.floor(Math.random() * 50)),
                    quality: parseFloat(props.habitat_quality || props.quality || props.Quality || props.habitat_score || Math.random() * 100),
                    description: props.description || props.Description || props.notes || `${datasetType.charAt(0).toUpperCase() + datasetType.slice(1)} dataset location for ML model`,
                    dataset: datasetType,
                    feature_id: props.id || props.ID || props.FID || index,
                    geometry: geometryForDisplay,
                    isPolygon: isPolygon,
                    threat_level: props.threat_level || ['low', 'medium', 'high'][Math.floor(Math.random() * 3)],
                    management_priority: props.management_priority || ['low', 'medium', 'high'][Math.floor(Math.random() * 3)],
                    originalProps: props
                };
                
                if (index < 3) {
                    console.log(`Sample ${datasetType} feature:`, {
                        name: siteData.name,
                        coords: [lat, lng],
                        area: siteData.area,
                        isPolygon: isPolygon
                    });
                }
                
                prairieData.push(siteData);
                allFeatures.push({...feature, displayData: siteData});
            });
        }

        // Process connectivity features (lines/corridors)
        function processConnectivityFeatures(data) {
            console.log(`Processing ${data.features.length} connectivity features`);
            data.features.forEach((feature, index) => {
                if (feature.geometry.type === 'LineString' || feature.geometry.type === 'MultiLineString') {
                    const props = feature.properties;
                    const corridor = {
                        name: props.name || props.corridor_name || `Corridor ${index + 1}`,
                        coordinates: feature.geometry.coordinates.map(coord => [coord[1], coord[0]]), // Leaflet uses [lat, lng]
                        quality: props.quality || props.connectivity_quality || ['high', 'medium', 'low'][Math.floor(Math.random() * 3)],
                        length: parseFloat(props.length_km || props.length || Math.random() * 10),
                        threats: props.threats ? props.threats.split(',') : ['development', 'fragmentation'],
                        originalProps: props
                    };
                    exampleCorridors.push(corridor);
                    console.log(`Processed corridor: ${corridor.name}`);
                }
            });
        }

        // Update data source controls based on what was successfully loaded
        function updateDataSourceControls(loadedDatasets) {
            const controls = {
                'show-training': loadedDatasets.includes('training'),
                'show-validation': loadedDatasets.includes('validation')
            };

            Object.entries(controls).forEach(([controlId, hasData]) => {
                const control = document.getElementById(controlId);
                const label = control.nextElementSibling;
                
                if (hasData) {
                    control.disabled = false;
                    label.style.opacity = '1';
                    label.title = 'Data loaded successfully';
                } else {
                    control.disabled = true;
                    control.checked = false;
                    label.style.opacity = '0.5';
                    label.title = 'Data file not found or failed to load';
                }
            });
        }

        // Refresh/filter iNaturalist data based on current settings
        function refreshINaturalistData() {
            if (originalINaturalistData.length === 0) {
                showError('No iNaturalist data loaded. Check that data/iNat.geojson exists.');
                return;
            }

            applyFilters();
            showSuccess(`Filtered to ${iNaturalistData.length} species meeting criteria`);
        }

        // Enhanced display functions with proper symbolization
        function updatePrairieDisplay() {
            const connectivityMin = parseFloat(document.getElementById('connectivity-filter').value);
            const speciesMin = parseInt(document.getElementById('species-filter').value);
            const showTraining = document.getElementById('show-training').checked;
            const showValidation = document.getElementById('show-validation').checked;
            const showExample = document.getElementById('show-example').checked;
            
            // Update display values
            document.getElementById('connectivity-value').textContent = connectivityMin;
            document.getElementById('species-value').textContent = speciesMin;
            
            prairieLayer.clearLayers();
            
            let visibleCount = 0;
            
            prairieData.forEach(prairie => {
                // Filter by dataset type
                if ((prairie.dataset === 'training' && !showTraining) ||
                    (prairie.dataset === 'validation' && !showValidation) ||
                    (prairie.dataset === 'example' && !showExample)) {
                    return;
                }
                
                // Filter by metrics
                if (prairie.connectivity >= connectivityMin && prairie.species >= speciesMin) {
                    let marker;
                    
                    if (prairie.isPolygon && prairie.geometry) {
                        // Render as polygon for training/validation features
                        const coords = prairie.geometry.type === 'Polygon' ? 
                            prairie.geometry.coordinates[0].map(coord => [coord[1], coord[0]]) :
                            prairie.geometry.coordinates[0][0].map(coord => [coord[1], coord[0]]);
                            
                        marker = L.polygon(coords, {
                            color: getDatasetColor(prairie.dataset),
                            weight: 2,
                            opacity: 0.8,
                            fillColor: prairie.dataset === 'example' ? getQualityColor(prairie.quality) : getDatasetColor(prairie.dataset),
                            fillOpacity: 0.6
                        });
                    } else {
                        // Render as circle marker for point features or fallback
                        const radius = Math.sqrt(prairie.area || 10) / 2 + 5;
                        marker = L.circleMarker([prairie.lat, prairie.lng], {
                            radius: radius,
                            fillColor: prairie.dataset === 'example' ? getQualityColor(prairie.quality) : getDatasetColor(prairie.dataset),
                            color: getDatasetColor(prairie.dataset),
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    }

                    const popupContent = `
                        <div class="popup-content">
                            <h3>${prairie.name}</h3>
                            <div class="popup-metric">
                                <span>Dataset:</span>
                                <strong>${prairie.dataset.charAt(0).toUpperCase() + prairie.dataset.slice(1)}</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Geometry:</span>
                                <strong>${prairie.isPolygon ? 'Polygon' : 'Point'}</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Area:</span>
                                <strong>${(prairie.area || 0).toFixed(1)} hectares</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Connectivity:</span>
                                <strong>${prairie.connectivity.toFixed(1)}%</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Species Count:</span>
                                <strong>${prairie.species}</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Habitat Quality:</span>
                                <strong>${prairie.quality.toFixed(1)}%</strong>
                            </div>
                            ${prairie.threat_level ? `
                            <div class="popup-metric">
                                <span>Threat Level:</span>
                                <strong style="color: ${prairie.threat_level === 'high' ? '#dc3545' : prairie.threat_level === 'medium' ? '#ffc107' : '#28a745'}">${prairie.threat_level.charAt(0).toUpperCase() + prairie.threat_level.slice(1)}</strong>
                            </div>` : ''}
                            ${prairie.management_priority ? `
                            <div class="popup-metric">
                                <span>Management Priority:</span>
                                <strong>${prairie.management_priority.charAt(0).toUpperCase() + prairie.management_priority.slice(1)}</strong>
                            </div>` : ''}
                            <p style="margin-top: 10px; font-style: italic; color: #666;">${prairie.description}</p>
                        </div>
                    `;

                    marker.bindPopup(popupContent, { maxWidth: 400 });
                    marker.addTo(prairieLayer);
                    visibleCount++;
                }
            });
            
            console.log(`Displayed ${visibleCount} prairie sites`);
            updateStats();
        }

        // Update species observations display with enhanced filtering
        function updateSpeciesDisplay() {
            const showINaturalist = document.getElementById('show-inaturalist').checked;
            speciesLayer.clearLayers();
            
            if (showINaturalist && iNaturalistData.length > 0) {
                iNaturalistData.forEach(species => {
                    const marker = L.circleMarker([species.lat, species.lng], {
                        radius: getObservationRadius(species.count),
                        fillColor: getSpeciesColor(species),
                        color: '#4a6b00',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    
                    const popupContent = createEnhancedPopup(species);

                    marker.bindPopup(popupContent, {
                        maxWidth: 400,
                        className: 'enhanced-inat-popup'
                    });
                    marker.addTo(speciesLayer);
                });
                
                console.log(`Displayed ${iNaturalistData.length} species observations`);
            }
        }

        // Update connectivity corridors display
        function updateConnectivityDisplay() {
            connectivityLayer.clearLayers();
            
            exampleCorridors.forEach(corridor => {
                const color = corridor.quality === 'high' ? '#28a745' : 
                             corridor.quality === 'medium' ? '#ffc107' : '#dc3545';
                
                const polyline = L.polyline(corridor.coordinates, {
                    color: color,
                    weight: 4,
                    opacity: 0.8
                });
                
                const
