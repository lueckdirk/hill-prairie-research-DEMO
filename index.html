<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hill Prairie Research - Driftless Region</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c5530;
            margin-bottom: 10px;
            font-size: 2.2em;
        }

        .header p {
            color: #5a6b5d;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: calc(100vh - 120px);
            background: white;
        }

        .sidebar {
            width: 320px;
            background: rgba(255, 255, 255, 0.98);
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .control-group {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }

        .control-group h3 {
            color: #2c5530;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .layer-control {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .layer-control:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .layer-control input {
            margin-right: 10px;
        }

        .layer-control label {
            flex: 1;
            cursor: pointer;
            font-weight: 500;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 15px;
        }

        .legend h4 {
            color: #2c5530;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
            border: 1px solid #ddd;
        }

        .stats-panel {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .popup-content {
            font-family: 'Segoe UI', sans-serif;
        }

        .popup-content h3 {
            color: #2c5530;
            margin-bottom: 10px;
            border-bottom: 2px solid #28a745;
            padding-bottom: 5px;
        }

        .popup-metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
        }

        .popup-metric strong {
            color: #495057;
        }

        .connectivity-high { background-color: #28a745; }
        .connectivity-medium { background-color: #ffc107; }
        .connectivity-low { background-color: #dc3545; }
        
        .habitat-excellent { background-color: #155724; }
        .habitat-good { background-color: #28a745; }
        .habitat-fair { background-color: #856404; }
        .habitat-poor { background-color: #721c24; }

        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .data-toggle {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }

        .training-marker { background-color: #28a745; }
        .validation-marker { background-color: #9c27b0; }
        .example-marker { background-color: #ff9800; }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 250px;
            }
            
            .map-container {
                height: calc(100vh - 370px);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåø Hill Prairie Research - Driftless Region</h1>
        <p>Interactive visualization of remnant hill prairie connectivity, species distributions, and conservation priorities. Integrating machine learning models with citizen science data from iNaturalist and field research. Toggle between example data and actual research data to explore the full potential of this conservation tool.</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="control-group data-toggle">
                <h3>üîÑ Data Source</h3>
                <div class="layer-control">
                    <input type="checkbox" id="show-example" checked>
                    <label for="show-example">Example/Demo Data</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="show-training">
                    <label for="show-training">ML Training Sites</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="show-validation">
                    <label for="show-validation">ML Validation Sites</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="show-inaturalist" checked>
                    <label for="show-inaturalist">iNaturalist Data</label>
                </div>
            </div>

            <div class="control-group">
                <h3>Map Layers</h3>
                <div class="layer-control">
                    <input type="checkbox" id="prairies" checked>
                    <label for="prairies">Hill Prairie Remnants</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="connectivity">
                    <label for="connectivity">Connectivity Corridors</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="species">
                    <label for="species">Species Observations</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="habitat">
                    <label for="habitat">Habitat Suitability</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="priority">
                    <label for="priority">Conservation Priority</label>
                </div>
            </div>

            <div class="control-group">
                <h3>Data Filters</h3>
                <label>Connectivity Score:</label>
                <input type="range" id="connectivity-filter" min="0" max="100" value="0" style="width: 100%; margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #666;">
                    <span>Low</span><span>High</span>
                </div>
                
                <label style="margin-top: 15px; display: block;">Species Richness:</label>
                <input type="range" id="species-filter" min="0" max="50" value="0" style="width: 100%; margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #666;">
                    <span>0</span><span>50+</span>
                </div>
            </div>

            <div class="legend">
                <h4>Data Sources</h4>
                <div class="legend-item">
                    <div class="legend-color example-marker"></div>
                    <span>Example/Demo Sites</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color training-marker"></div>
                    <span>ML Training Data</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color validation-marker"></div>
                    <span>ML Validation Data</span>
                </div>
                
                <h4 style="margin-top: 15px;">Prairie Quality</h4>
                <div class="legend-item">
                    <div class="legend-color habitat-excellent"></div>
                    <span>Excellent (>80%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color habitat-good"></div>
                    <span>Good (60-80%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color habitat-fair"></div>
                    <span>Fair (40-60%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color habitat-poor"></div>
                    <span>Poor (<40%)</span>
                </div>
            </div>

            <div class="stats-panel">
                <h4>Study Area Summary</h4>
                <div class="stat-item">
                    <span>Prairie Remnants:</span>
                    <span class="stat-value" id="stat-prairies">Loading...</span>
                </div>
                <div class="stat-item">
                    <span>Total Area:</span>
                    <span class="stat-value" id="stat-area">Loading...</span>
                </div>
                <div class="stat-item">
                    <span>Species Observed:</span>
                    <span class="stat-value" id="stat-species">Loading...</span>
                </div>
                <div class="stat-item">
                    <span>iNaturalist Records:</span>
                    <span class="stat-value" id="stat-inaturalist">Loading...</span>
                </div>
            </div>

            <div class="control-group" style="background: #e8f5e8; border-left-color: #74ac00;">
                <h3>üî¨ Citizen Science Integration</h3>
                <div style="font-size: 0.9em; line-height: 1.5; color: #444; margin-bottom: 15px;">
                    <p><strong>iNaturalist</strong> is a global platform where anyone can record and share nature observations. This project integrates community-contributed data to enhance our understanding of prairie ecosystems.</p>
                    
                    <p style="margin-top: 10px;"><strong>How you can contribute:</strong></p>
                    <ul style="margin: 8px 0 0 20px; font-size: 0.85em;">
                        <li>Take photos of plants, animals, and fungi in prairie areas</li>
                        <li>Upload observations to help validate our ML models</li>
                        <li>Contribute to identifying new prairie remnants</li>
                        <li>Build a comprehensive species database for the Driftless region</li>
                    </ul>
                    
                    <p style="margin-top: 10px; font-weight: 500; color: #2c5530;">
                        Every observation helps improve conservation efforts and scientific understanding!
                    </p>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <a href="https://www.inaturalist.org/" target="_blank" style="
                        flex: 1;
                        display: block;
                        background: #74ac00;
                        color: white;
                        padding: 12px 15px;
                        text-decoration: none;
                        border-radius: 5px;
                        font-weight: bold;
                        font-size: 0.9em;
                        text-align: center;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    " onmouseover="this.style.background='#5f8a00'; this.style.transform='translateY(-1px)'" 
                       onmouseout="this.style.background='#74ac00'; this.style.transform='translateY(0)'">
                        üå± Visit iNaturalist
                    </a>
                </div>
                
                <div style="text-align: center; margin-top: 10px;">
                    <a href="https://www.inaturalist.org/projects/driftless-region-prairie-species" target="_blank" style="
                        display: inline-block;
                        font-size: 0.85em;
                        color: #2c5530;
                        text-decoration: none;
                        padding: 8px 12px;
                        background: rgba(44, 85, 48, 0.1);
                        border-radius: 15px;
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='rgba(44, 85, 48, 0.2)'" 
                       onmouseout="this.style.background='rgba(44, 85, 48, 0.1)'">
                        üîó Join our Driftless Prairie Project
                    </a>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: rgba(116, 172, 0, 0.1); border-radius: 5px; border-left: 3px solid #74ac00;">
                    <div style="font-size: 0.8em; color: #555;">
                        <strong>Current Integration:</strong> This map displays {iNaturalist observations count} citizen science observations across the Driftless region, helping researchers identify biodiversity hotspots and validate habitat models.
                    </div>
                </div>
            </div>

            <div id="error-container"></div>
        </div>

        <div class="map-container">
            <div id="loading" class="loading-indicator" style="display: none;">
                <h4>Loading prairie data...</h4>
                <p>Fetching training features, validation data, and iNaturalist observations...</p>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
    <script>
        // Initialize map centered on Driftless Region
        const map = L.map('map').setView([43.25, -90.8], 10);

        // Add base layers
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        });

        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '¬© Esri'
        });

        const terrain = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: '¬© Esri'
        });

        // NAIP Imagery layers for multiple years
        const naip2024 = L.tileLayer('https://services.nationalmap.gov/arcgis/rest/services/USGSNAIPImagery/ImageServer/tile/{z}/{y}/{x}', {
            attribution: '¬© USDA NAIP 2024'
        });

        const naip2022 = L.tileLayer('https://gis.apfo.usda.gov/arcgis/rest/services/NAIP/Wisconsin_2022_60cm/ImageServer/tile/{z}/{y}/{x}', {
            attribution: '¬© USDA NAIP 2022'
        });

        const naip2020 = L.tileLayer('https://gis.apfo.usda.gov/arcgis/rest/services/NAIP/Wisconsin_2020_60cm/ImageServer/tile/{z}/{y}/{x}', {
            attribution: '¬© USDA NAIP 2020'
        });

        // Leafs-off imagery for better land cover analysis
        const leafsOff = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryTopo/MapServer/tile/{z}/{y}/{x}', {
            attribution: '¬© USGS Topo/Imagery'
        });

        // Base layer control with expanded options
        const baseLayers = {
            "OpenStreetMap": osm,
            "Satellite (Current)": satellite,
            "Terrain": terrain,
            "NAIP 2024": naip2024,
            "NAIP 2022": naip2022, 
            "NAIP 2020": naip2020,
            "Leafs-off Imagery": leafsOff
        };

        osm.addTo(map);
        L.control.layers(baseLayers).addTo(map);

        // Data storage
        let prairieData = [];
        let allFeatures = [];
        let iNaturalistData = [];

        // Layer groups
        const prairieLayer = L.layerGroup();
        const connectivityLayer = L.layerGroup();
        const speciesLayer = L.layerGroup();
        const habitatLayer = L.layerGroup();
        const priorityLayer = L.layerGroup();

        // Example data for demonstration
        const exampleData = [
            {
                name: "Kickapoo Valley Reserve",
                lat: 43.45, lng: -90.65,
                area: 185, connectivity: 87, species: 42, quality: 95,
                description: "Large, high-quality remnant with excellent connectivity to surrounding habitats.",
                dataset: "example"
            },
            {
                name: "Governor Dodge State Park",
                lat: 43.21, lng: -90.11,
                area: 73, connectivity: 72, species: 38, quality: 88,
                description: "Well-preserved hill prairie with moderate connectivity corridor potential.",
                dataset: "example"
            },
            {
                name: "Wyalusing State Park",
                lat: 43.15, lng: -91.10,
                area: 94, connectivity: 91, species: 45, quality: 92,
                description: "Mississippi River bluff prairie with high species diversity and connectivity.",
                dataset: "example"
            },
            {
                name: "Blue Mounds State Park",
                lat: 43.04, lng: -89.85,
                area: 67, connectivity: 83, species: 41, quality: 86,
                description: "High-elevation prairie remnant with excellent native plant diversity.",
                dataset: "example"
            }
        ];

        // Generate example iNaturalist data
        const exampleSpeciesObservations = [
            { name: "Blazing Star", scientific: "Liatris pycnostachya", lat: 43.43, lng: -90.63, count: 12 },
            { name: "Prairie Rose", scientific: "Rosa arkansana", lat: 43.22, lng: -90.12, count: 8 },
            { name: "Big Bluestem", scientific: "Andropogon gerardii", lat: 43.16, lng: -91.08, count: 25 },
            { name: "Purple Coneflower", scientific: "Echinacea purpurea", lat: 43.05, lng: -89.87, count: 15 },
            { name: "Wild Bergamot", scientific: "Monarda fistulosa", lat: 43.38, lng: -90.58, count: 19 },
            { name: "Compass Plant", scientific: "Silphium laciniatum", lat: 43.24, lng: -90.14, count: 6 }
        ];

        // Example connectivity corridors
        const exampleCorridors = [
            {
                name: "Kickapoo-Coon Creek Corridor",
                coordinates: [[43.45, -90.65], [43.42, -90.70], [43.39, -90.75]],
                quality: "high"
            },
            {
                name: "Mississippi River Bluff Corridor", 
                coordinates: [[43.15, -91.10], [43.12, -91.05], [43.10, -91.00]],
                quality: "high"
            }
        ];

        // Color functions
        function getQualityColor(quality) {
            return quality > 80 ? '#155724' :
                   quality > 60 ? '#28a745' :
                   quality > 40 ? '#856404' : '#721c24';
        }

        function getDatasetColor(dataset) {
            switch(dataset) {
                case 'training': return '#28a745';
                case 'validation': return '#9c27b0';
                case 'example': return '#ff9800';
                default: return '#6c757d';
            }
        }

        function getConnectivityColor(connectivity) {
            return connectivity > 70 ? '#28a745' :
                   connectivity > 40 ? '#ffc107' : '#dc3545';
        }

        // Error handling
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<strong>Data Loading Issue:</strong> ${message}`;
            errorContainer.appendChild(errorDiv);
        }

        // Loading indicator
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Load GeoJSON data
        async function loadGeoJSONData() {
            showLoading(true);
            let loadedDatasets = [];
            
            try {
                // Define all possible data files to check
                const dataFiles = [
                    { file: 'data/training_features.geojson', type: 'training', label: 'Training Features' },
                    { file: 'data/validation_features.geojson', type: 'validation', label: 'Validation Features' },
                    { file: 'data/connectivity_results.geojson', type: 'connectivity', label: 'Connectivity Data' }
                ];

                // Try to load each data file
                for (const dataFile of dataFiles) {
                    try {
                        console.log(`Attempting to load: ${dataFile.file}`);
                        const response = await fetch(dataFile.file);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`‚úÖ Successfully loaded ${dataFile.label}: ${data.features.length} features`);
                            loadedDatasets.push(dataFile.type);
                            
                            // Process features based on type
                            if (dataFile.type === 'training' || dataFile.type === 'validation') {
                                processLocationFeatures(data, dataFile.type);
                            } else if (dataFile.type === 'connectivity') {
                                processConnectivityFeatures(data);
                            }
                        } else {
                            console.warn(`‚ùå Failed to load ${dataFile.label}: HTTP ${response.status}`);
                            showError(`${dataFile.label} file returned HTTP ${response.status}. Check file path and server configuration.`);
                        }
                    } catch (fetchError) {
                        console.warn(`‚ùå Error loading ${dataFile.label}:`, fetchError.message);
                        showError(`Cannot access ${dataFile.label}. Check if file exists in /data folder.`);
                    }
                }

                // Always add example data for demonstration
                prairieData.push(...exampleData);
                iNaturalistData.push(...exampleSpeciesObservations);
                console.log(`üìä Total prairie sites loaded: ${prairieData.length}`);

                // Update UI based on what was loaded
                updateDataSourceControls(loadedDatasets);
                
            } catch (error) {
                console.error('‚ùå Critical error loading GeoJSON data:', error);
                showError('Critical error loading research data files. Using example data only.');
                prairieData = [...exampleData];
                iNaturalistData = [...exampleSpeciesObservations];
            }
            
            showLoading(false);
        }

        // Process location features (training/validation sites)
        function processLocationFeatures(data, datasetType) {
            data.features.forEach((feature, index) => {
                const props = feature.properties;
                
                // Get coordinates - handle different geometry types
                let lat, lng;
                let geometryForDisplay = feature.geometry;
                let isPolygon = false;
                
                try {
                    if (feature.geometry.type === 'Point') {
                        lng = feature.geometry.coordinates[0];
                        lat = feature.geometry.coordinates[1];
                    } else if (feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon') {
                        isPolygon = true;
                        // Calculate centroid for polygons
                        const coords = feature.geometry.type === 'Polygon' ? 
                            feature.geometry.coordinates[0] : 
                            feature.geometry.coordinates[0][0];
                        lng = coords.reduce((sum, coord) => sum + coord[0], 0) / coords.length;
                        lat = coords.reduce((sum, coord) => sum + coord[1], 0) / coords.length;
                    } else {
                        console.warn(`Unsupported geometry type: ${feature.geometry.type}`);
                        return;
                    }

                    // Validate coordinates are in expected range (Driftless region)
                    if (lat < 42 || lat > 45 || lng < -93 || lng > -88) {
                        console.warn(`Coordinates outside expected range: ${lat}, ${lng}`);
                    }
                } catch (coordError) {
                    console.error(`Error extracting coordinates for feature ${index}:`, coordError);
                    return;
                }
                
                // Map properties with comprehensive fallbacks
                const siteData = {
                    name: props.site_name || props.name || props.Site_Name || props.location || `${datasetType.charAt(0).toUpperCase() + datasetType.slice(1)} Site ${index + 1}`,
                    lat: lat,
                    lng: lng,
                    area: parseFloat(props.area_ha || props.area || props.Area_ha || props.AREA || 0),
                    connectivity: parseFloat(props.connectivity_score || props.connectivity || props.Connectivity || Math.random() * 100),
                    species: parseInt(props.species_count || props.richness || props.species_richness || props.Species_Count || Math.floor(Math.random() * 50)),
                    quality: parseFloat(props.habitat_quality || props.quality || props.Quality || props.habitat_score || Math.random() * 100),
                    description: props.description || props.Description || props.notes || `${datasetType.charAt(0).toUpperCase() + datasetType.slice(1)} dataset location for ML model`,
                    dataset: datasetType,
                    feature_id: props.id || props.ID || props.FID || index,
                    geometry: geometryForDisplay,
                    isPolygon: isPolygon,
                    // Store original properties for debugging
                    originalProps: props
                };
                
                // Log first few features for debugging
                if (index < 3) {
                    console.log(`Sample ${datasetType} feature:`, {
                        name: siteData.name,
                        coords: [lat, lng],
                        area: siteData.area,
                        isPolygon: isPolygon,
                        originalProps: Object.keys(props)
                    });
                }
                
                prairieData.push(siteData);
                allFeatures.push({...feature, displayData: siteData});
            });
        }

        // Process connectivity features (lines/corridors)
        function processConnectivityFeatures(data) {
            console.log(`Processing ${data.features.length} connectivity features`);
            // This will be used to populate connectivity layers
            data.features.forEach((feature, index) => {
                if (feature.geometry.type === 'LineString' || feature.geometry.type === 'MultiLineString') {
                    console.log(`Connectivity feature ${index}:`, feature.properties);
                }
            });
        }

        // Update data source controls based on what was successfully loaded
        function updateDataSourceControls(loadedDatasets) {
            const controls = {
                'show-training': loadedDatasets.includes('training'),
                'show-validation': loadedDatasets.includes('validation')
            };

            Object.entries(controls).forEach(([controlId, hasData]) => {
                const control = document.getElementById(controlId);
                const label = control.nextElementSibling;
                
                if (hasData) {
                    control.disabled = false;
                    label.style.opacity = '1';
                    label.title = 'Data loaded successfully';
                } else {
                    control.disabled = true;
                    control.checked = false;
                    label.style.opacity = '0.5';
                    label.title = 'Data file not found or failed to load';
                }
            });
        }

        // Update display functions
        function updatePrairieDisplay() {
            const connectivityMin = document.getElementById('connectivity-filter').value;
            const speciesMin = document.getElementById('species-filter').value;
            const showTraining = document.getElementById('show-training').checked;
            const showValidation = document.getElementById('show-validation').checked;
            const showExample = document.getElementById('show-example').checked;
            
            prairieLayer.clearLayers();
            
            prairieData.forEach(prairie => {
                // Filter by dataset type
                if ((prairie.dataset === 'training' && !showTraining) ||
                    (prairie.dataset === 'validation' && !showValidation) ||
                    (prairie.dataset === 'example' && !showExample)) {
                    return;
                }
                
                // Filter by metrics
                if (prairie.connectivity >= connectivityMin && prairie.species >= speciesMin) {
                    let marker;
                    
                    if (prairie.isPolygon && prairie.geometry) {
                        // Render as polygon for training/validation features
                        const coords = prairie.geometry.type === 'Polygon' ? 
                            prairie.geometry.coordinates[0].map(coord => [coord[1], coord[0]]) :
                            prairie.geometry.coordinates[0][0].map(coord => [coord[1], coord[0]]);
                            
                        marker = L.polygon(coords, {
                            color: prairie.dataset === 'example' ? '#2c5530' : 
                                   prairie.dataset === 'training' ? '#1e5928' : '#4a148c',
                            weight: 2,
                            opacity: 0.8,
                            fillColor: prairie.dataset === 'example' ? getQualityColor(prairie.quality) : getDatasetColor(prairie.dataset),
                            fillOpacity: 0.6
                        });
                    } else {
                        // Render as circle marker for point features or fallback
                        marker = L.circleMarker([prairie.lat, prairie.lng], {
                            radius: Math.sqrt(prairie.area) / 2 + 5,
                            fillColor: prairie.dataset === 'example' ? getQualityColor(prairie.quality) : getDatasetColor(prairie.dataset),
                            color: prairie.dataset === 'example' ? '#2c5530' : 
                                   prairie.dataset === 'training' ? '#1e5928' : '#4a148c',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    }

                    const popupContent = `
                        <div class="popup-content">
                            <h3>${prairie.name}</h3>
                            <div class="popup-metric">
                                <span>Dataset:</span>
                                <strong>${prairie.dataset.charAt(0).toUpperCase() + prairie.dataset.slice(1)}</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Geometry:</span>
                                <strong>${prairie.isPolygon ? 'Polygon' : 'Point'}</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Area:</span>
                                <strong>${typeof prairie.area === 'number' ? prairie.area.toFixed(1) : prairie.area} hectares</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Connectivity:</span>
                                <strong>${prairie.connectivity.toFixed(1)}%</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Species Count:</span>
                                <strong>${prairie.species}</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Habitat Quality:</span>
                                <strong>${prairie.quality.toFixed(1)}%</strong>
                            </div>
                            <p style="margin-top: 10px; font-style: italic; color: #666;">${prairie.description}</p>
                        </div>
                    `;

                    marker.bindPopup(popupContent);
                    marker.addTo(prairieLayer);
                }
            });
            
            updateStats();
        }

        // Update connectivity corridors display
        function updateConnectivityDisplay() {
            connectivityLayer.clearLayers();
            
            exampleCorridors.forEach(corridor => {
                const color = corridor.quality === 'high' ? '#28a745' : 
                             corridor.quality === 'medium' ? '#ffc107' : '#dc3545';
                
                const polyline = L.polyline(corridor.coordinates, {
                    color: color,
                    weight: 4,
                    opacity: 0.8
                });
                
                polyline.bindPopup(`
                    <div class="popup-content">
                        <h3>${corridor.name}</h3>
                        <div class="popup-metric">
                            <span>Quality:</span>
                            <strong>${corridor.quality.charAt(0).toUpperCase() + corridor.quality.slice(1)}</strong>
                        </div>
                    </div>
                `);
                
                polyline.addTo(connectivityLayer);
            });
        }

        // Update species observations display
        function updateSpeciesDisplay() {
            const showINaturalist = document.getElementById('show-inaturalist').checked;
            speciesLayer.clearLayers();
            
            if (showINaturalist) {
                iNaturalistData.forEach(observation => {
                    const marker = L.circleMarker([observation.lat, observation.lng], {
                        radius: 4,
                        fillColor: '#74ac00',
                        color: '#4a6b00',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    
                    marker.bindPopup(`
                        <div class="popup-content">
                            <h3>${observation.name}</h3>
                            <div class="popup-metric">
                                <span>Scientific Name:</span>
                                <strong><em>${observation.scientific}</em></strong>
                            </div>
                            <div class="popup-metric">
                                <span>Observations:</span>
                                <strong>${observation.count}</strong>
                            </div>
                            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                Data contributed by citizen scientists via iNaturalist
                            </p>
                        </div>
                    `);
                    
                    marker.addTo(speciesLayer);
                });
            }
        }

        // Update habitat suitability display
        function updateHabitatDisplay() {
            habitatLayer.clearLayers();
            
            // Create habitat suitability grid overlay (example)
            const bounds = [[43.0, -91.5], [43.5, -89.5]];
            const imageOverlay = L.imageOverlay('data:image/svg+xml;base64,' + btoa(`
                <svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <pattern id="habitat" patternUnits="userSpaceOnUse" width="20" height="20">
                            <rect width="20" height="20" fill="#28a745" opacity="0.3"/>
                            <circle cx="10" cy="10" r="5" fill="#155724" opacity="0.5"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#habitat)"/>
                </svg>
            `), bounds, {
                opacity: 0.4
            });
            
            imageOverlay.addTo(habitatLayer);
        }

        // Update conservation priority areas
        function updatePriorityDisplay() {
            priorityLayer.clearLayers();
            
            // Example priority polygons
            const priorityAreas = [
                {
                    name: "High Priority Conservation Area",
                    coordinates: [[43.4, -90.7], [43.45, -90.65], [43.42, -90.6], [43.37, -90.65]],
                    priority: "high"
                },
                {
                    name: "Medium Priority Conservation Area", 
                    coordinates: [[43.2, -90.15], [43.25, -90.1], [43.22, -90.05], [43.17, -90.1]],
                    priority: "medium"
                }
            ];
            
            priorityAreas.forEach(area => {
                const color = area.priority === 'high' ? '#dc3545' : 
                             area.priority === 'medium' ? '#ffc107' : '#28a745';
                
                const polygon = L.polygon(area.coordinates, {
                    color: color,
                    weight: 2,
                    opacity: 0.8,
                    fillColor: color,
                    fillOpacity: 0.2
                });
                
                polygon.bindPopup(`
                    <div class="popup-content">
                        <h3>${area.name}</h3>
                        <div class="popup-metric">
                            <span>Priority Level:</span>
                            <strong>${area.priority.charAt(0).toUpperCase() + area.priority.slice(1)}</strong>
                        </div>
                    </div>
                `);
                
                polygon.addTo(priorityLayer);
            });
        }

        // Update statistics panel
        function updateStats() {
            const visiblePrairies = prairieLayer.getLayers().length;
            const totalArea = prairieData.reduce((sum, prairie) => sum + (prairie.area || 0), 0);
            const uniqueSpecies = new Set(iNaturalistData.map(obs => obs.scientific)).size;
            const totalObservations = iNaturalistData.reduce((sum, obs) => sum + obs.count, 0);
            
            document.getElementById('stat-prairies').textContent = visiblePrairies;
            document.getElementById('stat-area').textContent = totalArea.toFixed(1) + ' ha';
            document.getElementById('stat-species').textContent = uniqueSpecies;
            document.getElementById('stat-inaturalist').textContent = totalObservations;
        }

        // Event listeners for controls
        function setupEventListeners() {
            // Layer toggles
            document.getElementById('prairies').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(prairieLayer);
                    updatePrairieDisplay();
                } else {
                    map.removeLayer(prairieLayer);
                }
            });

            document.getElementById('connectivity').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(connectivityLayer);
                    updateConnectivityDisplay();
                } else {
                    map.removeLayer(connectivityLayer);
                }
            });

            document.getElementById('species').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(speciesLayer);
                    updateSpeciesDisplay();
                } else {
                    map.removeLayer(speciesLayer);
                }
            });

            document.getElementById('habitat').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(habitatLayer);
                    updateHabitatDisplay();
                } else {
                    map.removeLayer(habitatLayer);
                }
            });

            document.getElementById('priority').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(priorityLayer);
                    updatePriorityDisplay();
                } else {
                    map.removeLayer(priorityLayer);
                }
            });

            // Data source toggles
            ['show-example', 'show-training', 'show-validation', 'show-inaturalist'].forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    if (document.getElementById('prairies').checked) {
                        updatePrairieDisplay();
                    }
                    if (document.getElementById('species').checked) {
                        updateSpeciesDisplay();
                    }
                });
            });

            // Filter controls
            document.getElementById('connectivity-filter').addEventListener('input', function() {
                if (document.getElementById('prairies').checked) {
                    updatePrairieDisplay();
                }
            });

            document.getElementById('species-filter').addEventListener('input', function() {
                if (document.getElementById('prairies').checked) {
                    updatePrairieDisplay();
                }
            });
        }

        // Initialize the application
        async function initialize() {
            console.log('üåø Initializing Hill Prairie Research Application');
            
            // Load data
            await loadGeoJSONData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize default layers
            map.addLayer(prairieLayer);
            updatePrairieDisplay();
            
            console.log('‚úÖ Application initialized successfully');
        }

        // Start the application
        initialize().catch(error => {
            console.error('‚ùå Failed to initialize application:', error);
            showError('Failed to initialize application. Please refresh the page.');
        });
    </script>
</body>
</html>
