<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hill Prairie Research - Driftless Region</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c5530;
            margin-bottom: 10px;
            font-size: 2.2em;
        }

        .header p {
            color: #5a6b5d;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: calc(100vh - 120px);
            background: white;
        }

        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.98);
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .control-group {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }

        .control-group h3 {
            color: #2c5530;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .layer-control {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .layer-control:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .layer-control input {
            margin-right: 10px;
        }

        .layer-control label {
            flex: 1;
            cursor: pointer;
            font-weight: 500;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 15px;
        }

        .legend h4 {
            color: #2c5530;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
            border: 1px solid #ddd;
        }

        .stats-panel {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .popup-content {
            font-family: 'Segoe UI', sans-serif;
        }

        .popup-content h3 {
            color: #2c5530;
            margin-bottom: 10px;
            border-bottom: 2px solid #28a745;
            padding-bottom: 5px;
        }

        .popup-metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
        }

        .popup-metric strong {
            color: #495057;
        }

        .connectivity-high { background-color: #28a745; }
        .connectivity-medium { background-color: #ffc107; }
        .connectivity-low { background-color: #dc3545; }
        
        .habitat-excellent { background-color: #155724; }
        .habitat-good { background-color: #28a745; }
        .habitat-fair { background-color: #856404; }
        .habitat-poor { background-color: #721c24; }

        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .data-toggle {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }

        .base-layer-toggle {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }

        .imagery-toggle {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .elevation-toggle {
            background: #fce4ec;
            border-left-color: #e91e63;
        }

        .training-marker { background-color: #28a745; }
        .validation-marker { background-color: #9c27b0; }
        .example-marker { background-color: #ff9800; }

        select {
            width: 100%;
            padding: 8px;
            margin: 5px 0 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }

        select:focus {
            border-color: #28a745;
            outline: none;
        }

        .layer-opacity {
            width: 100%;
            margin: 5px 0;
        }

        .opacity-label {
            font-size: 0.8em;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 300px;
            }
            
            .map-container {
                height: calc(100vh - 420px);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Hill Prairie Research - Driftless Region</h1>
        <p>Interactive visualization of remnant hill prairie connectivity, species distributions, and conservation priorities using Wisconsin DNR base layers and elevation data for comprehensive landscape analysis.</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="control-group base-layer-toggle">
                <h3>Wisconsin DNR Base Layers</h3>
                <div class="layer-control">
                    <input type="radio" id="base-basic" name="base-layer" value="basic" checked>
                    <label for="base-basic">Basic Basemap</label>
                </div>
                <div class="layer-control">
                    <input type="radio" id="base-leaf-on" name="base-layer" value="leaf-on">
                    <label for="base-leaf-on">Latest Leaf-On Imagery</label>
                </div>
                <div class="layer-control">
                    <input type="radio" id="base-leaf-off" name="base-layer" value="leaf-off">
                    <label for="base-leaf-off">Latest Leaf-Off Imagery</label>
                </div>
                <div class="layer-control">
                    <input type="radio" id="base-topo" name="base-layer" value="topo">
                    <label for="base-topo">Topographic Map</label>
                </div>
                <div class="layer-control">
                    <input type="radio" id="base-cir" name="base-layer" value="cir">
                    <label for="base-cir">Color Infrared</label>
                </div>
            </div>

            <div class="control-group data-toggle">
                <h3>Data Source</h3>
                <div class="layer-control">
                    <input type="checkbox" id="show-example" checked>
                    <label for="show-example">Example/Demo Data</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="show-training">
                    <label for="show-training">ML Training Sites</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="show-validation">
                    <label for="show-validation">ML Validation Sites</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="show-inaturalist" checked>
                    <label for="show-inaturalist">iNaturalist Data</label>
                </div>
            </div>

            <div class="control-group imagery-toggle">
                <h3>Historical Imagery Overlay</h3>
                <label for="imagery-select">Add Historical Layer:</label>
                <select id="imagery-select">
                    <option value="none">No Additional Imagery</option>
                    <option value="2022-leaf-on">2022 Leaf-On</option>
                    <option value="2020-leaf-on">2020 Leaf-On</option>
                    <option value="2015-leaf-on">2015 Leaf-On</option>
                    <option value="2013-leaf-on">2013 Leaf-On</option>
                    <option value="2010-leaf-off">2010 Leaf-Off</option>
                    <option value="2008-leaf-on">2008 Leaf-On</option>
                    <option value="2005-leaf-on">2005 Leaf-On</option>
                    <option value="1990s-leaf-off">1990s Leaf-Off</option>
                    <option value="1930s-leaf-on">1930s Leaf-On (Historic)</option>
                </select>
                <div class="opacity-label">
                    <span>Overlay Opacity:</span>
                    <span id="imagery-opacity-value">60%</span>
                </div>
                <input type="range" class="layer-opacity" id="imagery-opacity" min="0" max="100" value="60">
            </div>

            <div class="control-group elevation-toggle">
                <h3>Wisconsin DNR Elevation Overlay</h3>
                <label for="elevation-select">Add Terrain Analysis:</label>
                <select id="elevation-select">
                    <option value="none">No Elevation Layer</option>
                    <option value="hillshade-lidar">LiDAR Hillshade</option>
                    <option value="hillshade-10m">10m Hillshade</option>
                    <option value="dem-lidar">LiDAR DEM</option>
                    <option value="dem-lidar-colorized">LiDAR DEM (Colorized)</option>
                    <option value="dem-10m">10m DEM</option>
                    <option value="slope-lidar-degree">LiDAR Slope (Degrees)</option>
                    <option value="slope-lidar-percent">LiDAR Slope (Percent)</option>
                    <option value="contours-2ft">2ft Contours</option>
                    <option value="contours-5ft">5ft Contours</option>
                    <option value="contours-10ft">10ft Contours</option>
                </select>
                <div class="opacity-label">
                    <span>Overlay Opacity:</span>
                    <span id="elevation-opacity-value">50%</span>
                </div>
                <input type="range" class="layer-opacity" id="elevation-opacity" min="0" max="100" value="50">
            </div>

            <div class="control-group">
                <h3>Map Layers</h3>
                <div class="layer-control">
                    <input type="checkbox" id="prairies" checked>
                    <label for="prairies">Hill Prairie Remnants</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="connectivity">
                    <label for="connectivity">Connectivity Corridors</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="species">
                    <label for="species">Species Observations</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="habitat">
                    <label for="habitat">Habitat Suitability</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="priority">
                    <label for="priority">Conservation Priority</label>
                </div>
            </div>

            <div class="control-group">
                <h3>Data Filters</h3>
                <label>Connectivity Score:</label>
                <input type="range" id="connectivity-filter" min="0" max="100" value="0" style="width: 100%; margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #666;">
                    <span>Low</span><span>High</span>
                </div>
                
                <label style="margin-top: 15px; display: block;">Species Richness:</label>
                <input type="range" id="species-filter" min="0" max="50" value="0" style="width: 100%; margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #666;">
                    <span>0</span><span>50+</span>
                </div>
            </div>

            <div class="legend">
                <h4>Data Sources</h4>
                <div class="legend-item">
                    <div class="legend-color example-marker"></div>
                    <span>Example/Demo Sites</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color training-marker"></div>
                    <span>ML Training Data</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color validation-marker"></div>
                    <span>ML Validation Data</span>
                </div>
                
                <h4 style="margin-top: 15px;">Prairie Quality</h4>
                <div class="legend-item">
                    <div class="legend-color habitat-excellent"></div>
                    <span>Excellent (>80%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color habitat-good"></div>
                    <span>Good (60-80%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color habitat-fair"></div>
                    <span>Fair (40-60%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color habitat-poor"></div>
                    <span>Poor (<40%)</span>
                </div>
            </div>

            <div class="stats-panel">
                <h4>Study Area Summary</h4>
                <div class="stat-item">
                    <span>Prairie Remnants:</span>
                    <span class="stat-value" id="stat-prairies">Loading...</span>
                </div>
                <div class="stat-item">
                    <span>Total Area:</span>
                    <span class="stat-value" id="stat-area">Loading...</span>
                </div>
                <div class="stat-item">
                    <span>Species Observed:</span>
                    <span class="stat-value" id="stat-species">Loading...</span>
                </div>
                <div class="stat-item">
                    <span>iNaturalist Records:</span>
                    <span class="stat-value" id="stat-inaturalist">Loading...</span>
                </div>
            </div>

            <div class="legend">
                <h4>About iNaturalist</h4>
                <p style="margin-bottom: 10px; font-size: 0.9em; line-height: 1.4;">
                    <a href="https://www.inaturalist.org/" target="_blank" style="color: #74ac00; text-decoration: none;">iNaturalist</a> 
                    is a citizen science platform where researchers and nature enthusiasts contribute biodiversity observations. 
                    Species data shown here comes from the 
                    <a href="https://www.inaturalist.org/projects/driftless-remnant-hill-prairies" target="_blank" 
                       style="color: #74ac00; text-decoration: none; font-weight: bold;">
                       Driftless Remnant Hill Prairies
                    </a> project.
                </p>
                <p style="font-size: 0.8em; color: #666; margin-bottom: 15px;">
                    Join the project to contribute your own prairie species observations and help document these unique ecosystems!
                </p>
            </div>

            <div id="error-container"></div>
        </div>

        <div class="map-container">
            <div id="loading" class="loading-indicator" style="display: none;">
                <h4>Loading prairie data...</h4>
                <p>Fetching training features, validation data, and iNaturalist observations...</p>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
    <script>
        // Initialize map centered on Driftless Region
        const map = L.map('map').setView([43.25, -90.8], 10);

        // Wisconsin DNR services - using consistent endpoints
        const WI_DNR_CACHED = 'https://dnrmaps.wi.gov/arcgis/rest/services/DW_Map_Cached';
        const WI_DNR_IMAGE = 'https://dnrmaps.wi.gov/arcgis_image/rest/services';

        // Wisconsin DNR Base Layers - all from same projection system
        const baseLayers = {
            'basic': L.tileLayer(`${WI_DNR_CACHED}/EN_Basic_Basemap_WTM_Ext_Dynamic_L16/MapServer/tile/{z}/{y}/{x}`, {
                attribution: '© Wisconsin DNR - Basic Basemap',
                maxZoom: 16,
                errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'
            }),
            'leaf-on': L.tileLayer.wms(`${WI_DNR_IMAGE}/DW_Imagery/EN_Image_Basemap_Latest_Leaf_On/ImageServer/WMSServer`, {
                layers: '0',
                format: 'image/png',
                transparent: false,
                attribution: '© Wisconsin DNR - Latest Leaf-On Imagery',
                crs: L.CRS.EPSG3857
            }),
            'leaf-off': L.tileLayer.wms(`${WI_DNR_IMAGE}/DW_Imagery/EN_Image_Basemap_Latest_Leaf_Off/ImageServer/WMSServer`, {
                layers: '0',
                format: 'image/png',
                transparent: false,
                attribution: '© Wisconsin DNR - Latest Leaf-Off Imagery',
                crs: L.CRS.EPSG3857
            }),
            'topo': L.tileLayer(`${WI_DNR_CACHED}/EN_Topo_Basemap_WTM_Ext_Dynamic_L16/MapServer/tile/{z}/{y}/{x}`, {
                attribution: '© Wisconsin DNR - Topographic Map',
                maxZoom: 16,
                errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'
            }),
            'cir': L.tileLayer(`${WI_DNR_CACHED}/EN_Image_Basemap_Composite_CIR_WTM_Ext_Dynamic_L16/MapServer/tile/{z}/{y}/{x}`, {
                attribution: '© Wisconsin DNR - Color Infrared',
                maxZoom: 16,
                errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'
            })
        };

        // Historical imagery overlay layers
        const imageryLayers = {
            '2022-leaf-on': L.tileLayer.wms(`${WI_DNR_IMAGE}/DW_Imagery/EN_Image_Basemap_2022_Leaf_On/ImageServer/WMSServer`, {
                layers: '0',
                format: 'image/png',
                transparent: true,
                attribution: '© Wisconsin DNR 2022',
                crs: L.CRS.EPSG3857
            }),
            '2020-leaf-on': L.tileLayer.wms(`${WI_DNR_IMAGE}/DW_Imagery/EN_Image_Basemap_2020_Leaf_On/ImageServer/WMSServer`, {
                layers: '0',
                format: 'image/png',
                transparent: true,
                attribution: '© Wisconsin DNR 2020',
                crs: L.CRS.EPSG3857
            }),
            '2015-leaf-on': L.tileLayer.wms(`${WI_DNR_IMAGE}/DW_Imagery/EN_Image_Basemap_2015_Leaf_On/ImageServer/WMSServer`, {
                layers: '0',
                format: 'image/png',
                transparent: true,
                attribution: '© Wisconsin DNR 2015',
                crs: L.CRS.EPSG3857
            }),
            '2010-leaf-off': L.tileLayer.wms(`${WI_DNR_IMAGE}/DW_Imagery/EN_Image_Basemap_2010_Leaf_Off/ImageServer/WMSServer`, {
                layers: '0',
                format: 'image/png',
                transparent: true,
                attribution: '© Wisconsin DNR 2010',
                crs: L.CRS.EPSG3857
            }),
            '2005-leaf-on': L.tileLayer.wms(`${WI_DNR_IMAGE}/DW_Imagery/EN_Image_Basemap_2005_Leaf_On/ImageServer/WMSServer`, {
                layers: '0',
                format: 'image/png',
                transparent: true,
                attribution: '© Wisconsin DNR 2005',
                crs: L.CRS.EPSG3857
            })
        };

        // Wisconsin DNR Elevation layers
        const elevationLayers = {
            'hillshade-lidar': L.tileLayer.wms(`${WI_DNR_IMAGE}/DW_Elevation/EN_Hillshade_from_LiDAR/ImageServer/WMSServer`, {
                layers: '0',
                format: 'image/png',
                transparent: true,
                attribution: '© Wisconsin DNR LiDAR',
                crs: L.CRS.EPSG3857
            }),
            'dem-lidar-colorized': L.tileLayer.wms(`${WI_DNR_IMAGE}/DW_Elevation/EN_DEM_from_LiDAR_Colorized/ImageServer/WMSServer`, {
                layers: '0',
                format: 'image/png',
                transparent: true,
                attribution: '© Wisconsin DNR LiDAR DEM',
                crs: L.CRS.EPSG3857
            }),
            'slope-lidar-degree': L.tileLayer.wms(`${WI_DNR_IMAGE}/DW_Elevation/EN_Slope_from_LiDAR_Degree/ImageServer/WMSServer`, {
                layers: '0',
                format: 'image/png',
                transparent: true,
                attribution: '© Wisconsin DNR LiDAR Slope',
                crs: L.CRS.EPSG3857
            }),
            'contours-2ft': L.tileLayer(`${WI_DNR_CACHED}/EN_Elevation_Contour_2ft_WTM_Ext_Dynamic_L19/MapServer/tile/{z}/{y}/{x}`, {
                attribution: '© Wisconsin DNR 2ft Contours',
                maxZoom: 19,
                minZoom: 14,
                errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'
            }),
            'contours-10ft': L.tileLayer(`${WI_DNR_CACHED}/EN_Elevation_Contour_10ft_WTM_Ext_Dynamic_L17/MapServer/tile/{z}/{y}/{x}`, {
                attribution: '© Wisconsin DNR 10ft Contours',
                maxZoom: 17,
                minZoom: 10,
                errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'
            })
        };

        // Start with basic Wisconsin DNR base layer
        let currentBaseLayer = baseLayers['basic'];
        currentBaseLayer.addTo(map);

        // Current overlay layers
        let currentImageryLayer = null;
        let currentElevationLayer = null;

        // Data storage
        let prairieData = [];
        let allFeatures = [];
        let iNaturalistData = [];

        // Layer groups
        const prairieLayer = L.layerGroup();
        const connectivityLayer = L.layerGroup();
        const speciesLayer = L.layerGroup();
        const habitatLayer = L.layerGroup();
        const priorityLayer = L.layerGroup();

        // Example data for demonstration
        const exampleData = [
            {
                name: "Kickapoo Valley Reserve",
                lat: 43.45, lng: -90.65,
                area: 185, connectivity: 87, species: 42, quality: 95,
                description: "Large, high-quality remnant with excellent connectivity to surrounding habitats.",
                dataset: "example"
            },
            {
                name: "Governor Dodge State Park",
                lat: 43.21, lng: -90.11,
                area: 73, connectivity: 72, species: 38, quality: 88,
                description: "Well-preserved hill prairie with moderate connectivity corridor potential.",
                dataset: "example"
            },
            {
                name: "Wyalusing State Park",
                lat: 43.15, lng: -91.10,
                area: 94, connectivity: 91, species: 45, quality: 92,
                description: "Mississippi River bluff prairie with high species diversity and connectivity.",
                dataset: "example"
            },
            {
                name: "Blue Mounds State Park",
                lat: 43.04, lng: -89.85,
                area: 67, connectivity: 83, species: 41, quality: 86,
                description: "High-elevation prairie remnant with excellent native plant diversity.",
                dataset: "example"
            }
        ];

        // Generate example iNaturalist data
        const exampleSpeciesObservations = [
            { name: "Blazing Star", scientific: "Liatris pycnostachya", lat: 43.43, lng: -90.63, count: 12 },
            { name: "Prairie Rose", scientific: "Rosa arkansana", lat: 43.22, lng: -90.12, count: 8 },
            { name: "Big Bluestem", scientific: "Andropogon gerardii", lat: 43.16, lng: -91.08, count: 25 },
            { name: "Purple Coneflower", scientific: "Echinacea purpurea", lat: 43.05, lng: -89.87, count: 15 },
            { name: "Wild Bergamot", scientific: "Monarda fistulosa", lat: 43.38, lng: -90.58, count: 19 },
            { name: "Compass Plant", scientific: "Silphium laciniatum", lat: 43.24, lng: -90.14, count: 6 }
        ];

        // Example connectivity corridors
        const exampleCorridors = [
            {
                name: "Kickapoo-Coon Creek Corridor",
                coordinates: [[43.45, -90.65], [43.42, -90.70], [43.39, -90.75]],
                quality: "high"
            },
            {
                name: "Mississippi River Bluff Corridor", 
                coordinates: [[43.15, -91.10], [43.12, -91.05], [43.10, -91.00]],
                quality: "high"
            }
        ];

        // Color functions
        function getQualityColor(quality) {
            return quality > 80 ? '#155724' :
                   quality > 60 ? '#28a745' :
                   quality > 40 ? '#856404' : '#721c24';
        }

        function getDatasetColor(dataset) {
            switch(dataset) {
                case 'training': return '#28a745';
                case 'validation': return '#9c27b0';
                case 'example': return '#ff9800';
                default: return '#6c757d';
            }
        }

        // Base layer management
        function switchBaseLayer(layerType) {
            // Remove current base layer
            if (currentBaseLayer) {
                map.removeLayer(currentBaseLayer);
            }
            
            // Add new base layer
            if (baseLayers[layerType]) {
                currentBaseLayer = baseLayers[layerType];
                
                // Add error handling for base layer
                const isWMS = currentBaseLayer.wmsParams !== undefined;
                
                currentBaseLayer.on('tileerror', function(e) {
                    console.warn(`Base layer error for ${layerType}:`, e.error);
                    showError(`Unable to load ${layerType} base layer. Wisconsin DNR service may be temporarily unavailable.`);
                });
                
                if (isWMS) {
                    currentBaseLayer.on('loading', function(e) {
                        console.log(`Loading WMS base layer: ${layerType}`);
                    });
                    
                    currentBaseLayer.on('load', function(e) {
                        console.log(`Successfully loaded WMS base layer: ${layerType}`);
                    });
                }
                
                try {
                    currentBaseLayer.addTo(map);
                    console.log(`Switched to base layer: ${layerType} (${isWMS ? 'WMS' : 'Tile'} service)`);
                } catch (addError) {
                    console.error(`Error adding base layer ${layerType}:`, addError);
                    showError(`Failed to initialize ${layerType} base layer.`);
                }
            }
        }

        // Layer management functions with improved error handling
        function updateImageryLayer() {
            const selectedImagery = document.getElementById('imagery-select').value;
            const opacity = document.getElementById('imagery-opacity').value / 100;
            
            // Remove current imagery layer
            if (currentImageryLayer) {
                map.removeLayer(currentImageryLayer);
                currentImageryLayer = null;
            }
            
            // Add new imagery layer if selected
            if (selectedImagery !== 'none' && imageryLayers[selectedImagery]) {
                currentImageryLayer = imageryLayers[selectedImagery];
                currentImageryLayer.setOpacity(opacity);
                
                // Enhanced error handling for WMS services
                let tileLoadAttempts = 0;
                const maxRetries = 2;
                
                console.log(`Loading WMS imagery overlay: ${selectedImagery}`);
                
                currentImageryLayer.on('loading', function(e) {
                    console.log(`WMS imagery overlay loading: ${selectedImagery}`);
                });
                
                currentImageryLayer.on('load', function(e) {
                    console.log(`Successfully loaded WMS imagery overlay: ${selectedImagery}`);
                });
                
                currentImageryLayer.on('tileerror', function(e) {
                    tileLoadAttempts++;
                    console.warn(`Imagery overlay loading error for ${selectedImagery} (attempt ${tileLoadAttempts}):`, e.error);
                    
                    if (tileLoadAttempts >= maxRetries) {
                        showError(`Unable to load ${selectedImagery.replace('-', ' ')} imagery overlay. The Wisconsin DNR service may be temporarily unavailable.`);
                    }
                });
                
                try {
                    currentImageryLayer.addTo(map);
                    console.log(`Added imagery overlay: ${selectedImagery} (WMS service)`);
                    
                    // Test load with timeout for WMS
                    setTimeout(() => {
                        if (currentImageryLayer && !currentImageryLayer._loaded) {
                            console.warn(`WMS imagery service ${selectedImagery} taking longer than expected to load`);
                        }
                    }, 5000);
                } catch (addError) {
                    console.error(`Error adding imagery overlay ${selectedImagery}:`, addError);
                    showError(`Failed to initialize ${selectedImagery.replace('-', ' ')} imagery overlay.`);
                }
            }
        }

        function updateElevationLayer() {
            const selectedElevation = document.getElementById('elevation-select').value;
            const opacity = document.getElementById('elevation-opacity').value / 100;
            
            // Remove current elevation layer
            if (currentElevationLayer) {
                map.removeLayer(currentElevationLayer);
                currentElevationLayer = null;
            }
            
            // Add new elevation layer if selected
            if (selectedElevation !== 'none' && elevationLayers[selectedElevation]) {
                currentElevationLayer = elevationLayers[selectedElevation];
                currentElevationLayer.setOpacity(opacity);
                
                // Enhanced error handling for WMS vs tile services
                const isWMS = currentElevationLayer.wmsParams !== undefined;
                let tileLoadAttempts = 0;
                const maxRetries = 2;
                
                if (isWMS) {
                    console.log(`Loading WMS elevation overlay: ${selectedElevation}`);
                    
                    currentElevationLayer.on('loading', function(e) {
                        console.log(`WMS elevation overlay loading: ${selectedElevation}`);
                    });
                    
                    currentElevationLayer.on('load', function(e) {
                        console.log(`Successfully loaded WMS elevation overlay: ${selectedElevation}`);
                    });
                } else {
                    console.log(`Loading tile elevation overlay: ${selectedElevation}`);
                    
                    currentElevationLayer.on('tileloadstart', function(e) {
                        console.log(`Loading elevation tile overlay: ${selectedElevation}`);
                    });
                    
                    currentElevationLayer.on('tileload', function(e) {
                        console.log(`Successfully loaded elevation tile overlay for ${selectedElevation}`);
                    });
                }
                
                currentElevationLayer.on('tileerror', function(e) {
                    tileLoadAttempts++;
                    console.warn(`Elevation overlay loading error for ${selectedElevation} (attempt ${tileLoadAttempts}):`, e.error);
                    
                    if (tileLoadAttempts >= maxRetries) {
                        const serviceType = isWMS ? 'WMS service' : 'tile service';
                        showError(`Unable to load ${selectedElevation.replace('-', ' ')} elevation overlay (${serviceType}). The Wisconsin DNR service may be temporarily unavailable.`);
                    }
                });
                
                try {
                    currentElevationLayer.addTo(map);
                    console.log(`Added elevation overlay: ${selectedElevation} (${isWMS ? 'WMS' : 'Tile'} service)`);
                    
                    // Test load with timeout for WMS
                    if (isWMS) {
                        setTimeout(() => {
                            if (currentElevationLayer && !currentElevationLayer._loaded) {
                                console.warn(`WMS elevation service ${selectedElevation} taking longer than expected to load`);
                            }
                        }, 5000);
                    }
                } catch (addError) {
                    console.error(`Error adding elevation overlay ${selectedElevation}:`, addError);
                    showError(`Failed to initialize ${selectedElevation.replace('-', ' ')} elevation overlay.`);
                }
            }
        }

        // Error handling
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<strong>Layer Loading Issue:</strong> ${message}`;
            errorContainer.appendChild(errorDiv);
            
            // Auto-remove error after 10 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 10000);
        }

        // Loading indicator
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Load GeoJSON data
        async function loadGeoJSONData() {
            showLoading(true);
            let loadedDatasets = [];
            
            try {
                // Define all possible data files to check
                const dataFiles = [
                    { file: 'data/training_features.geojson', type: 'training', label: 'Training Features' },
                    { file: 'data/validation_features.geojson', type: 'validation', label: 'Validation Features' },
                    { file: 'data/connectivity_results.geojson', type: 'connectivity', label: 'Connectivity Data' }
                ];

                // Try to load each data file
                for (const dataFile of dataFiles) {
                    try {
                        console.log(`Attempting to load: ${dataFile.file}`);
                        const response = await fetch(dataFile.file);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`✅ Successfully loaded ${dataFile.label}: ${data.features.length} features`);
                            loadedDatasets.push(dataFile.type);
                            
                            // Process features based on type
                            if (dataFile.type === 'training' || dataFile.type === 'validation') {
                                processLocationFeatures(data, dataFile.type);
                            } else if (dataFile.type === 'connectivity') {
                                processConnectivityFeatures(data);
                            }
                        } else {
                            console.warn(`❌ Failed to load ${dataFile.label}: HTTP ${response.status}`);
                            showError(`${dataFile.label} file returned HTTP ${response.status}. Check file path and server configuration.`);
                        }
                    } catch (fetchError) {
                        console.warn(`❌ Error loading ${dataFile.label}:`, fetchError.message);
                        showError(`Cannot access ${dataFile.label}. Check if file exists in /data folder.`);
                    }
                }

                // Always add example data for demonstration
                prairieData.push(...exampleData);
                iNaturalistData.push(...exampleSpeciesObservations);
                console.log(`📊 Total prairie sites loaded: ${prairieData.length}`);

                // Update UI based on what was loaded
                updateDataSourceControls(loadedDatasets);
                
            } catch (error) {
                console.error('❌ Critical error loading GeoJSON data:', error);
                showError('Critical error loading research data files. Using example data only.');
                prairieData = [...exampleData];
                iNaturalistData = [...exampleSpeciesObservations];
            }
            
            showLoading(false);
        }

        // Process location features (training/validation sites)
        function processLocationFeatures(data, datasetType) {
            data.features.forEach((feature, index) => {
                const props = feature.properties;
                
                // Get coordinates - handle different geometry types
                let lat, lng;
                let geometryForDisplay = feature.geometry;
                let isPolygon = false;
                
                try {
                    if (feature.geometry.type === 'Point') {
                        lng = feature.geometry.coordinates[0];
                        lat = feature.geometry.coordinates[1];
                    } else if (feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon') {
                        isPolygon = true;
                        // Calculate centroid for polygons
                        const coords = feature.geometry.type === 'Polygon' ? 
                            feature.geometry.coordinates[0] : 
                            feature.geometry.coordinates[0][0];
                        lng = coords.reduce((sum, coord) => sum + coord[0], 0) / coords.length;
                        lat = coords.reduce((sum, coord) => sum + coord[1], 0) / coords.length;
                    } else {
                        console.warn(`Unsupported geometry type: ${feature.geometry.type}`);
                        return;
                    }

                    // Validate coordinates are in expected range (Driftless region)
                    if (lat < 42 || lat > 45 || lng < -93 || lng > -88) {
                        console.warn(`Coordinates outside expected range: ${lat}, ${lng}`);
                    }
                } catch (coordError) {
                    console.error(`Error extracting coordinates for feature ${index}:`, coordError);
                    return;
                }
                
                // Map properties with comprehensive fallbacks
                const siteData = {
                    name: props.site_name || props.name || props.Site_Name || props.location || `${datasetType.charAt(0).toUpperCase() + datasetType.slice(1)} Site ${index + 1}`,
                    lat: lat,
                    lng: lng,
                    area: parseFloat(props.area_ha || props.area || props.Area_ha || props.AREA || 0),
                    connectivity: parseFloat(props.connectivity_score || props.connectivity || props.Connectivity || Math.random() * 100),
                    species: parseInt(props.species_count || props.richness || props.species_richness || props.Species_Count || Math.floor(Math.random() * 50)),
                    quality: parseFloat(props.habitat_quality || props.quality || props.Quality || props.habitat_score || Math.random() * 100),
                    description: props.description || props.Description || props.notes || `${datasetType.charAt(0).toUpperCase() + datasetType.slice(1)} dataset location for ML model`,
                    dataset: datasetType,
                    feature_id: props.id || props.ID || props.FID || index,
                    geometry: geometryForDisplay,
                    isPolygon: isPolygon,
                    // Store original properties for debugging
                    originalProps: props
                };
                
                // Log first few features for debugging
                if (index < 3) {
                    console.log(`Sample ${datasetType} feature:`, {
                        name: siteData.name,
                        coords: [lat, lng],
                        area: siteData.area,
                        isPolygon: isPolygon,
                        originalProps: Object.keys(props)
                    });
                }
                
                prairieData.push(siteData);
                allFeatures.push({...feature, displayData: siteData});
            });
        }

        // Process connectivity features (lines/corridors)
        function processConnectivityFeatures(data) {
            console.log(`Processing ${data.features.length} connectivity features`);
            // This will be used to populate connectivity layers
            data.features.forEach((feature, index) => {
                if (feature.geometry.type === 'LineString' || feature.geometry.type === 'MultiLineString') {
                    console.log(`Connectivity feature ${index}:`, feature.properties);
                }
            });
        }

        // Update data source controls based on what was successfully loaded
        function updateDataSourceControls(loadedDatasets) {
            const controls = {
                'show-training': loadedDatasets.includes('training'),
                'show-validation': loadedDatasets.includes('validation')
            };

            Object.entries(controls).forEach(([controlId, hasData]) => {
                const control = document.getElementById(controlId);
                const label = control.nextElementSibling;
                
                if (hasData) {
                    control.disabled = false;
                    label.style.opacity = '1';
                    label.title = 'Data loaded successfully';
                } else {
                    control.disabled = true;
                    control.checked = false;
                    label.style.opacity = '0.5';
                    label.title = 'Data file not found or failed to load';
                }
            });
        }

        // Update display functions
        function updatePrairieDisplay() {
            const connectivityMin = document.getElementById('connectivity-filter').value;
            const speciesMin = document.getElementById('species-filter').value;
            const showTraining = document.getElementById('show-training').checked;
            const showValidation = document.getElementById('show-validation').checked;
            const showExample = document.getElementById('show-example').checked;
            
            prairieLayer.clearLayers();
            
            prairieData.forEach(prairie => {
                // Filter by dataset type
                if ((prairie.dataset === 'training' && !showTraining) ||
                    (prairie.dataset === 'validation' && !showValidation) ||
                    (prairie.dataset === 'example' && !showExample)) {
                    return;
                }
                
                // Filter by metrics
                if (prairie.connectivity >= connectivityMin && prairie.species >= speciesMin) {
                    let marker;
                    
                    if (prairie.isPolygon && prairie.geometry) {
                        // Render as polygon for training/validation features
                        const coords = prairie.geometry.type === 'Polygon' ? 
                            prairie.geometry.coordinates[0].map(coord => [coord[1], coord[0]]) :
                            prairie.geometry.coordinates[0][0].map(coord => [coord[1], coord[0]]);
                            
                        marker = L.polygon(coords, {
                            color: prairie.dataset === 'example' ? '#2c5530' : 
                                   prairie.dataset === 'training' ? '#1e5928' : '#4a148c',
                            weight: 2,
                            opacity: 0.8,
                            fillColor: prairie.dataset === 'example' ? getQualityColor(prairie.quality) : getDatasetColor(prairie.dataset),
                            fillOpacity: 0.6
                        });
                    } else {
                        // Render as circle marker for point features or fallback
                        marker = L.circleMarker([prairie.lat, prairie.lng], {
                            radius: Math.sqrt(prairie.area) / 2 + 5,
                            fillColor: prairie.dataset === 'example' ? getQualityColor(prairie.quality) : getDatasetColor(prairie.dataset),
                            color: prairie.dataset === 'example' ? '#2c5530' : 
                                   prairie.dataset === 'training' ? '#1e5928' : '#4a148c',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    }

                    const popupContent = `
                        <div class="popup-content">
                            <h3>${prairie.name}</h3>
                            <div class="popup-metric">
                                <span>Dataset:</span>
                                <strong>${prairie.dataset.charAt(0).toUpperCase() + prairie.dataset.slice(1)}</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Geometry:</span>
                                <strong>${prairie.isPolygon ? 'Polygon' : 'Point'}</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Area:</span>
                                <strong>${typeof prairie.area === 'number' ? prairie.area.toFixed(1) : prairie.area} hectares</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Connectivity:</span>
                                <strong>${prairie.connectivity.toFixed(1)}%</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Species Count:</span>
                                <strong>${prairie.species}</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Habitat Quality:</span>
                                <strong>${prairie.quality.toFixed(1)}%</strong>
                            </div>
                            <p style="margin-top: 10px; font-style: italic; color: #666;">${prairie.description}</p>
                        </div>
                    `;

                    marker.bindPopup(popupContent);
                    marker.addTo(prairieLayer);
                }
            });
            
            updateStats();
        }

        // Update connectivity corridors display
        function updateConnectivityDisplay() {
            connectivityLayer.clearLayers();
            
            exampleCorridors.forEach(corridor => {
                const color = corridor.quality === 'high' ? '#28a745' : 
                             corridor.quality === 'medium' ? '#ffc107' : '#dc3545';
                
                const polyline = L.polyline(corridor.coordinates, {
                    color: color,
                    weight: 4,
                    opacity: 0.8
                });
                
                polyline.bindPopup(`
                    <div class="popup-content">
                        <h3>${corridor.name}</h3>
                        <div class="popup-metric">
                            <span>Quality:</span>
                            <strong>${corridor.quality.charAt(0).toUpperCase() + corridor.quality.slice(1)}</strong>
                        </div>
                    </div>
                `);
                
                polyline.addTo(connectivityLayer);
            });
        }

        // Update species observations display
        function updateSpeciesDisplay() {
            const showINaturalist = document.getElementById('show-inaturalist').checked;
            speciesLayer.clearLayers();
            
            if (showINaturalist) {
                iNaturalistData.forEach(observation => {
                    const marker = L.circleMarker([observation.lat, observation.lng], {
                        radius: 4,
                        fillColor: '#74ac00',
                        color: '#4a6b00',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    
                    marker.bindPopup(`
                        <div class="popup-content">
                            <h3>${observation.name}</h3>
                            <div class="popup-metric">
                                <span>Scientific Name:</span>
                                <strong><em>${observation.scientific}</em></strong>
                            </div>
                            <div class="popup-metric">
                                <span>Observations:</span>
                                <strong>${observation.count}</strong>
                            </div>
                            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                Data contributed by citizen scientists via iNaturalist
                            </p>
                        </div>
                    `);
                    
                    marker.addTo(speciesLayer);
                });
            }
        }

        // Update habitat suitability display
        function updateHabitatDisplay() {
            habitatLayer.clearLayers();
            
            // Create habitat suitability grid overlay (example)
            const bounds = [[43.0, -91.5], [43.5, -89.5]];
            const imageOverlay = L.imageOverlay('data:image/svg+xml;base64,' + btoa(`
                <svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <pattern id="habitat" patternUnits="userSpaceOnUse" width="20" height="20">
                            <rect width="20" height="20" fill="#28a745" opacity="0.3"/>
                            <circle cx="10" cy="10" r="5" fill="#155724" opacity="0.5"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#habitat)"/>
                </svg>
            `), bounds, {
                opacity: 0.4
            });
            
            imageOverlay.addTo(habitatLayer);
        }

        // Update conservation priority areas
        function updatePriorityDisplay() {
            priorityLayer.clearLayers();
            
            // Example priority polygons
            const priorityAreas = [
                {
                    name: "High Priority Conservation Area",
                    coordinates: [[43.4, -90.7], [43.45, -90.65], [43.42, -90.6], [43.37, -90.65]],
                    priority: "high"
                },
                {
                    name: "Medium Priority Conservation Area", 
                    coordinates: [[43.2, -90.15], [43.25, -90.1], [43.22, -90.05], [43.17, -90.1]],
                    priority: "medium"
                }
            ];
            
            priorityAreas.forEach(area => {
                const color = area.priority === 'high' ? '#dc3545' : 
                             area.priority === 'medium' ? '#ffc107' : '#28a745';
                
                const polygon = L.polygon(area.coordinates, {
                    color: color,
                    weight: 2,
                    opacity: 0.8,
                    fillColor: color,
                    fillOpacity: 0.2
                });
                
                polygon.bindPopup(`
                    <div class="popup-content">
                        <h3>${area.name}</h3>
                        <div class="popup-metric">
                            <span>Priority Level:</span>
                            <strong>${area.priority.charAt(0).toUpperCase() + area.priority.slice(1)}</strong>
                        </div>
                    </div>
                `);
                
                polygon.addTo(priorityLayer);
            });
        }

        // Update statistics panel
        function updateStats() {
            const visiblePrairies = prairieLayer.getLayers().length;
            const totalArea = prairieData.reduce((sum, prairie) => sum + (prairie.area || 0), 0);
            const uniqueSpecies = new Set(iNaturalistData.map(obs => obs.scientific)).size;
            const totalObservations = iNaturalistData.reduce((sum, obs) => sum + obs.count, 0);
            
            document.getElementById('stat-prairies').textContent = visiblePrairies;
            document.getElementById('stat-area').textContent = totalArea.toFixed(1) + ' ha';
            document.getElementById('stat-species').textContent = uniqueSpecies;
            document.getElementById('stat-inaturalist').textContent = totalObservations;
        }

        // Event listeners for controls
        function setupEventListeners() {
            // Base layer radio buttons
            document.querySelectorAll('input[name="base-layer"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        switchBaseLayer(this.value);
                    }
                });
            });

            // Imagery layer controls
            document.getElementById('imagery-select').addEventListener('change', updateImageryLayer);
            document.getElementById('imagery-opacity').addEventListener('input', function() {
                document.getElementById('imagery-opacity-value').textContent = this.value + '%';
                if (currentImageryLayer) {
                    currentImageryLayer.setOpacity(this.value / 100);
                }
            });

            // Elevation layer controls
            document.getElementById('elevation-select').addEventListener('change', updateElevationLayer);
            document.getElementById('elevation-opacity').addEventListener('input', function() {
                document.getElementById('elevation-opacity-value').textContent = this.value + '%';
                if (currentElevationLayer) {
                    currentElevationLayer.setOpacity(this.value / 100);
                }
            });

            // Layer toggles
            document.getElementById('prairies').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(prairieLayer);
                    updatePrairieDisplay();
                } else {
                    map.removeLayer(prairieLayer);
                }
            });

            document.getElementById('connectivity').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(connectivityLayer);
                    updateConnectivityDisplay();
                } else {
                    map.removeLayer(connectivityLayer);
                }
            });

            document.getElementById('species').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(speciesLayer);
                    updateSpeciesDisplay();
                } else {
                    map.removeLayer(speciesLayer);
                }
            });

            document.getElementById('habitat').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(habitatLayer);
                    updateHabitatDisplay();
                } else {
                    map.removeLayer(habitatLayer);
                }
            });

            document.getElementById('priority').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(priorityLayer);
                    updatePriorityDisplay();
                } else {
                    map.removeLayer(priorityLayer);
                }
            });

            // Data source toggles
            ['show-example', 'show-training', 'show-validation', 'show-inaturalist'].forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    if (document.getElementById('prairies').checked) {
                        updatePrairieDisplay();
                    }
                    if (document.getElementById('species').checked) {
                        updateSpeciesDisplay();
                    }
                });
            });

            // Filter controls
            document.getElementById('connectivity-filter').addEventListener('input', function() {
                if (document.getElementById('prairies').checked) {
                    updatePrairieDisplay();
                }
            });

            document.getElementById('species-filter').addEventListener('input', function() {
                if (document.getElementById('prairies').checked) {
                    updatePrairieDisplay();
                }
            });
        }

        // Initialize the application
        async function initialize() {
            console.log('Hill Prairie Research Application - Wisconsin DNR Base Layers Only');
            console.log('All layers sourced from Wisconsin DNR for consistent projection');
            
            // Test base layer connectivity and provide fallback
            currentBaseLayer.on('tileerror', function(e) {
                console.warn('Wisconsin DNR basic basemap failed, trying topographic map');
                switchBaseLayer('topo');
            });
            
            // Load data
            await loadGeoJSONData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize default layers
            map.addLayer(prairieLayer);
            updatePrairieDisplay();
            
            console.log('Application initialized successfully with Wisconsin DNR base layers');
            console.log('Available base layers: Basic, Leaf-On Imagery, Leaf-Off Imagery, Topographic, Color Infrared');
        }

        // Start the application
        initialize().catch(error => {
            console.error('Failed to initialize application:', error);
            showError('Failed to initialize application. Please refresh the page.');
        });
    </script>
</body>
</html>
