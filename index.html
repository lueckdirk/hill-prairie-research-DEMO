<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hill Prairie Research - Driftless Region</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c5530;
            margin-bottom: 10px;
            font-size: 2.2em;
        }

        .header p {
            color: #5a6b5d;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: calc(100vh - 120px);
            background: white;
        }

        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.98);
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .control-group {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }

        .control-group h3 {
            color: #2c5530;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .layer-control {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .layer-control:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .layer-control input {
            margin-right: 10px;
        }

        .layer-control label {
            flex: 1;
            cursor: pointer;
            font-weight: 500;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 15px;
        }

        .legend h4 {
            color: #2c5530;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
            border: 1px solid #ddd;
        }

        .stats-panel {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .popup-content {
            font-family: 'Segoe UI', sans-serif;
        }

        .popup-content h3 {
            color: #2c5530;
            margin-bottom: 10px;
            border-bottom: 2px solid #28a745;
            padding-bottom: 5px;
        }

        .popup-metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
        }

        .popup-metric strong {
            color: #495057;
        }

        .connectivity-high { background-color: #28a745; }
        .connectivity-medium { background-color: #ffc107; }
        .connectivity-low { background-color: #dc3545; }
        
        .habitat-excellent { background-color: #155724; }
        .habitat-good { background-color: #28a745; }
        .habitat-fair { background-color: #856404; }
        .habitat-poor { background-color: #721c24; }

        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #28a745;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        .data-toggle {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }

        .imagery-toggle {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .elevation-toggle {
            background: #fce4ec;
            border-left-color: #e91e63;
        }

        .training-marker { background-color: #28a745; }
        .validation-marker { background-color: #9c27b0; }
        .example-marker { background-color: #ff9800; }

        select {
            width: 100%;
            padding: 8px;
            margin: 5px 0 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }

        select:focus {
            border-color: #28a745;
            outline: none;
        }

        .layer-opacity {
            width: 100%;
            margin: 5px 0;
        }

        .opacity-label {
            font-size: 0.8em;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        .api-status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }

        .api-status.loading {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .api-status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .api-status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-icon {
            margin-right: 8px;
            font-size: 1.1em;
        }

        .refresh-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .refresh-button:hover {
            background: #218838;
        }

        .refresh-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .taxon-filter {
            margin-top: 15px;
        }

        .taxon-filter select {
            margin-bottom: 10px;
        }

        .filter-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.85em;
            color: #0366d6;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 350px;
            }
            
            .map-container {
                height: calc(100vh - 470px);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Hill Prairie Research - Driftless Region</h1>
        <p>Interactive visualization of remnant hill prairie connectivity, species distributions, and conservation priorities in the Driftless Region. Live data from iNaturalist API integrated with research datasets.</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="control-group data-toggle">
                <h3>Data Sources</h3>
                <div class="layer-control">
                    <input type="checkbox" id="show-example" checked>
                    <label for="show-example">Example/Demo Prairie Sites</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="show-inaturalist" checked>
                    <label for="show-inaturalist">Live iNaturalist Data</label>
                </div>
                
                <div id="inaturalist-status" class="api-status loading">
                    <span class="status-icon">🔄</span>
                    <span>Loading iNaturalist observations from local data...</span>
                </div>
                
                <button id="refresh-inaturalist" class="refresh-button" disabled>
                    Refresh Filters
                </button>
                
                <div class="taxon-filter">
                    <label for="taxon-select">Filter by taxon (informational):</label>
                    <select id="taxon-select" disabled>
                        <option value="">Data pre-filtered for prairie species</option>
                        <option value="47126">Plants (Plantae)</option>
                        <option value="47158">Flowering Plants</option>
                        <option value="47604">Grasses</option>
                        <option value="47602">Sedges</option>
                        <option value="558449">Prairie Plants</option>
                    </select>
                </div>
                
                <div class="filter-info">
                    <strong>Data Source:</strong> Pre-downloaded iNaturalist observations<br>
                    <strong>Area:</strong> Remnant prairie sites + buffer zones<br>
                    <strong>File:</strong> data/iNat.geojson<br>
                    <strong>Active Filter:</strong> Minimum observations per species
                </div>
            </div>

            <div class="control-group">
                <h3>Map Layers</h3>
                <div class="layer-control">
                    <input type="checkbox" id="prairies" checked>
                    <label for="prairies">Hill Prairie Remnants</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="connectivity">
                    <label for="connectivity">Connectivity Corridors</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="species">
                    <label for="species">Species Observations</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="habitat">
                    <label for="habitat">Habitat Suitability</label>
                </div>
            </div>

            <div class="control-group">
                <h3>Data Filters</h3>
                <label>Date Range (months ago):</label>
                <input type="range" id="date-filter" min="1" max="60" value="12" style="width: 100%; margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #666;">
                    <span>1 month</span><span>5 years</span>
                </div>
                
                <label style="margin-top: 15px; display: block;">Min observations per species:</label>
                <input type="range" id="min-obs-filter" min="1" max="20" value="2" style="width: 100%; margin: 10px 0;">
                <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #666;">
                    <span>1</span><span>20+</span>
                </div>
            </div>

            <div class="legend">
                <h4>Data Sources</h4>
                <div class="legend-item">
                    <div class="legend-color example-marker"></div>
                    <span>Example Prairie Sites</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #74ac00;"></div>
                    <span>iNaturalist Observations</span>
                </div>
                
                <h4 style="margin-top: 15px;">Observation Frequency</h4>
                <div class="legend-item">
                    <div style="width: 12px; height: 12px; background: #74ac00; border-radius: 50%; margin-right: 13px; border: 1px solid #4a6b00;"></div>
                    <span>1-5 observations</span>
                </div>
                <div class="legend-item">
                    <div style="width: 16px; height: 16px; background: #74ac00; border-radius: 50%; margin-right: 11px; border: 1px solid #4a6b00;"></div>
                    <span>6-15 observations</span>
                </div>
                <div class="legend-item">
                    <div style="width: 20px; height: 20px; background: #74ac00; border-radius: 50%; margin-right: 9px; border: 1px solid #4a6b00;"></div>
                    <span>16+ observations</span>
                </div>
            </div>

            <div class="stats-panel">
                <h4>Live Data Summary</h4>
                <div class="stat-item">
                    <span>iNaturalist Observations:</span>
                    <span class="stat-value" id="stat-inaturalist">Loading...</span>
                </div>
                <div class="stat-item">
                    <span>Unique Species:</span>
                    <span class="stat-value" id="stat-species">Loading...</span>
                </div>
                <div class="stat-item">
                    <span>Prairie Remnants:</span>
                    <span class="stat-value" id="stat-prairies">4</span>
                </div>
                <div class="stat-item">
                    <span>Last Updated:</span>
                    <span class="stat-value" id="stat-updated">Never</span>
                </div>
            </div>

            <div class="legend">
                <h4>About Your iNaturalist Data</h4>
                <p style="margin-bottom: 10px; font-size: 0.9em; line-height: 1.4;">
                    Displaying pre-downloaded iNaturalist observations from within and around your identified prairie remnants. This targeted dataset provides comprehensive species documentation specific to your study areas without API limitations.
                </p>
                <p style="font-size: 0.8em; color: #666; margin-bottom: 15px;">
                    Data includes observations from research-grade citizen science contributions focused on prairie ecosystems in the Driftless Region.
                </p>
            </div>

            <div id="error-container"></div>
        </div>

        <div class="map-container">
            <div id="loading" class="loading-indicator" style="display: none;">
                <div class="loading-spinner"></div>
                <h4>Loading prairie data...</h4>
                <p>Fetching live iNaturalist observations from API...</p>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
    <script>
        // Initialize map centered on Driftless Region
        const map = L.map('map').setView([43.25, -90.8], 9);

        // Add base layers
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        });

        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri'
        });

        const topo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri'
        });

        // Base layer control
        const baseLayers = {
            "OpenStreetMap": osm,
            "Satellite": satellite,
            "Topographic": topo
        };

        osm.addTo(map);
        L.control.layers(baseLayers).addTo(map);

        // Data storage
        let iNaturalistData = [];
        let prairieData = [];
        let loadingCount = 0;

        // Layer groups
        const prairieLayer = L.layerGroup();
        const connectivityLayer = L.layerGroup();
        const speciesLayer = L.layerGroup();
        const habitatLayer = L.layerGroup();

        // Example prairie sites data
        const examplePrairies = [
            {
                name: "Kickapoo Valley Reserve",
                lat: 43.45, lng: -90.65,
                area: 185, connectivity: 87, species: 42, quality: 95,
                description: "Large, high-quality remnant with excellent connectivity to surrounding habitats.",
                dataset: "example"
            },
            {
                name: "Governor Dodge State Park",
                lat: 43.21, lng: -90.11,
                area: 73, connectivity: 72, species: 38, quality: 88,
                description: "Well-preserved hill prairie with moderate connectivity corridor potential.",
                dataset: "example"
            },
            {
                name: "Wyalusing State Park",
                lat: 43.15, lng: -91.10,
                area: 94, connectivity: 91, species: 45, quality: 92,
                description: "Mississippi River bluff prairie with high species diversity and connectivity.",
                dataset: "example"
            },
            {
                name: "Blue Mounds State Park",
                lat: 43.04, lng: -89.85,
                area: 67, connectivity: 83, species: 41, quality: 86,
                description: "High-elevation prairie remnant with excellent native plant diversity.",
                dataset: "example"
            }
        ];

        // Driftless Region bounding box (SW Wisconsin, NE Iowa, SE Minnesota, NW Illinois)
        const DRIFTLESS_BOUNDS = {
            swlat: 42.0,   // Southern boundary
            swlng: -92.5,  // Western boundary  
            nelat: 44.5,   // Northern boundary
            nelng: -89.0   // Eastern boundary
        };

        // Status management
        function updateDataStatus(status, message) {
            const statusEl = document.getElementById('inaturalist-status');
            const refreshBtn = document.getElementById('refresh-inaturalist');
            
            statusEl.className = `api-status ${status}`;
            
            const icons = {
                loading: '🔄',
                success: '✅',
                error: '❌'
            };
            
            statusEl.innerHTML = `<span class="status-icon">${icons[status]}</span><span>${message}</span>`;
            
            refreshBtn.disabled = status === 'loading';
        }

        // Error handling
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<strong>API Error:</strong> ${message}`;
            errorContainer.appendChild(errorDiv);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                errorDiv.remove();
            }, 10000);
        }

        function showSuccess(message) {
            const errorContainer = document.getElementById('error-container');
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `<strong>Success:</strong> ${message}`;
            errorContainer.appendChild(successDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        // Loading indicator
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Load iNaturalist GeoJSON data
        async function loadINaturalistData() {
            updateDataStatus('loading', 'Loading iNaturalist observations...');
            showLoading(true);
            
            try {
                console.log('Attempting to load: data/iNat.geojson');
                const response = await fetch('data/iNat.geojson');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('iNaturalist GeoJSON loaded:', data);

                if (!data.features || !Array.isArray(data.features)) {
                    throw new Error('Invalid GeoJSON format - no features array found');
                }

                // Process the iNaturalist observations
                const processedData = [];
                const speciesMap = new Map();

                data.features.forEach((feature, index) => {
                    try {
                        const props = feature.properties;
                        const geometry = feature.geometry;
                        
                        if (!geometry || geometry.type !== 'Point') {
                            console.warn(`Feature ${index} has invalid geometry`);
                            return;
                        }

                        const [lng, lat] = geometry.coordinates;
                        
                        // Validate coordinates
                        if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                            console.warn(`Feature ${index} has invalid coordinates`);
                            return;
                        }

                        // Extract species information with various property name fallbacks
                        const speciesInfo = {
                            id: props.id || props.ID || props.observation_id || index,
                            taxon_id: props.taxon_id || props.species_id || props.taxon?.id,
                            name: props.common_name || props.species_name || props.taxon?.preferred_common_name || props.scientific_name || 'Unknown Species',
                            scientific: props.scientific_name || props.taxon?.name || props.species_scientific || 'Unknown',
                            lat: lat,
                            lng: lng,
                            quality_grade: props.quality_grade || props.grade || 'unknown',
                            observed_on: props.observed_on || props.observation_date || props.date,
                            user: props.user_login || props.observer || props.user?.login,
                            uri: props.uri || props.url || `https://www.inaturalist.org/observations/${props.id || props.observation_id || ''}`,
                            place_name: props.place_guess || props.location || props.place,
                            // Keep original properties for debugging
                            originalProps: props
                        };

                        // Create a unique key for grouping nearby observations of same species
                        const locationKey = `${speciesInfo.taxon_id}-${lat.toFixed(3)}-${lng.toFixed(3)}`;
                        
                        if (speciesMap.has(locationKey)) {
                            speciesMap.get(locationKey).count++;
                            speciesMap.get(locationKey).observations.push(feature);
                        } else {
                            speciesMap.set(locationKey, {
                                ...speciesInfo,
                                count: 1,
                                observations: [feature]
                            });
                        }
                        
                        // Log first few features for debugging
                        if (index < 3) {
                            console.log(`Sample iNaturalist feature ${index}:`, {
                                name: speciesInfo.name,
                                scientific: speciesInfo.scientific,
                                coords: [lat, lng],
                                properties: Object.keys(props)
                            });
                        }
                        
                    } catch (featureError) {
                        console.warn(`Error processing feature ${index}:`, featureError);
                    }
                });

                // Convert to array
                iNaturalistData = Array.from(speciesMap.values());
                
                const message = `Loaded ${iNaturalistData.length} unique species locations from ${data.features.length} observations`;
                updateDataStatus('success', message);
                showSuccess(message);
                
                // Update last updated time
                document.getElementById('stat-updated').textContent = new Date().toLocaleTimeString();
                
                return iNaturalistData;

            } catch (error) {
                console.error('Error loading iNaturalist GeoJSON:', error);
                const errorMsg = `Failed to load iNat.geojson: ${error.message}`;
                updateDataStatus('error', errorMsg);
                showError(errorMsg);
                return [];
            } finally {
                showLoading(false);
            }
        }

        // Color functions
        function getQualityColor(quality) {
            return quality > 80 ? '#155724' :
                   quality > 60 ? '#28a745' :
                   quality > 40 ? '#856404' : '#721c24';
        }

        function getObservationRadius(count) {
            return count <= 5 ? 6 : count <= 15 ? 8 : 10;
        }

        // Update display functions
        function updatePrairieDisplay() {
            const showExample = document.getElementById('show-example').checked;
            
            prairieLayer.clearLayers();
            
            if (showExample) {
                examplePrairies.forEach(prairie => {
                    const marker = L.circleMarker([prairie.lat, prairie.lng], {
                        radius: Math.sqrt(prairie.area) / 3 + 8,
                        fillColor: getQualityColor(prairie.quality),
                        color: '#2c5530',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.7
                    });

                    const popupContent = `
                        <div class="popup-content">
                            <h3>${prairie.name}</h3>
                            <div class="popup-metric">
                                <span>Area:</span>
                                <strong>${prairie.area} hectares</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Connectivity:</span>
                                <strong>${prairie.connectivity}%</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Species Count:</span>
                                <strong>${prairie.species}</strong>
                            </div>
                            <div class="popup-metric">
                                <span>Habitat Quality:</span>
                                <strong>${prairie.quality}%</strong>
                            </div>
                            <p style="margin-top: 10px; font-style: italic; color: #666;">${prairie.description}</p>
                        </div>
                    `;

                    marker.bindPopup(popupContent);
                    marker.addTo(prairieLayer);
                });
            }
        }

        // Update species observations display
        function updateSpeciesDisplay() {
            const showINaturalist = document.getElementById('show-inaturalist').checked;
            const minObs = document.getElementById('min-obs-filter').value;
            speciesLayer.clearLayers();
            
            if (showINaturalist && iNaturalistData.length > 0) {
                // Filter by minimum observation count
                const filteredData = iNaturalistData.filter(species => species.count >= minObs);
                
                filteredData.forEach(species => {
                    const marker = L.circleMarker([species.lat, species.lng], {
                        radius: getObservationRadius(species.count),
                        fillColor: '#74ac00',
                        color: '#4a6b00',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    
                    const popupContent = `
                        <div class="popup-content">
                            <h3>${species.name}</h3>
                            <div class="popup-metric">
                                <span>Scientific Name:</span>
                                <strong><em>${species.scientific}</em></strong>
                            </div>
                            <div class="popup-metric">
                                <span>Observations:</span>
                                <strong>${species.count}</strong>
                            </div>
                            ${species.quality_grade ? `
                            <div class="popup-metric">
                                <span>Quality Grade:</span>
                                <strong>${species.quality_grade}</strong>
                            </div>` : ''}
                            ${species.observed_on ? `
                            <div class="popup-metric">
                                <span>Last Observed:</span>
                                <strong>${species.observed_on}</strong>
                            </div>` : ''}
                            ${species.user ? `
                            <div class="popup-metric">
                                <span>Observer:</span>
                                <strong>${species.user}</strong>
                            </div>` : ''}
                            ${species.place_name ? `
                            <div class="popup-metric">
                                <span>Location:</span>
                                <strong>${species.place_name}</strong>
                            </div>` : ''}
                            ${species.uri ? `
                            <p style="margin-top: 10px; font-size: 0.9em;">
                                <a href="${species.uri}" target="_blank" style="color: #74ac00; text-decoration: none;">
                                    View on iNaturalist →
                                </a>
                            </p>` : ''}
                            <p style="margin-top: 5px; font-size: 0.8em; color: #666;">
                                Observations from prairie remnant buffer zones
                            </p>
                        </div>
                    `;

                    marker.bindPopup(popupContent);
                    marker.addTo(speciesLayer);
                });
                
                console.log(`Displayed ${filteredData.length} species observations`);
            }
        }

        // Update connectivity corridors display
        function updateConnectivityDisplay() {
            connectivityLayer.clearLayers();
            
            // Example connectivity corridors
            const exampleCorridors = [
                {
                    name: "Kickapoo-Coon Creek Corridor",
                    coordinates: [[43.45, -90.65], [43.42, -90.70], [43.39, -90.75]],
                    quality: "high"
                },
                {
                    name: "Mississippi River Bluff Corridor", 
                    coordinates: [[43.15, -91.10], [43.12, -91.05], [43.10, -91.00]],
                    quality: "high"
                }
            ];
            
            exampleCorridors.forEach(corridor => {
                const color = corridor.quality === 'high' ? '#28a745' : 
                             corridor.quality === 'medium' ? '#ffc107' : '#dc3545';
                
                const polyline = L.polyline(corridor.coordinates, {
                    color: color,
                    weight: 4,
                    opacity: 0.8
                });
                
                polyline.bindPopup(`
                    <div class="popup-content">
                        <h3>${corridor.name}</h3>
                        <div class="popup-metric">
                            <span>Quality:</span>
                            <strong>${corridor.quality.charAt(0).toUpperCase() + corridor.quality.slice(1)}</strong>
                        </div>
                    </div>
                `);
                
                polyline.addTo(connectivityLayer);
            });
        }

        // Update habitat suitability display
        function updateHabitatDisplay() {
            habitatLayer.clearLayers();
            
            // Create habitat suitability grid overlay
            const bounds = [[43.0, -91.5], [43.5, -89.5]];
            const imageOverlay = L.imageOverlay('data:image/svg+xml;base64,' + btoa(`
                <svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <pattern id="habitat" patternUnits="userSpaceOnUse" width="20" height="20">
                            <rect width="20" height="20" fill="#28a745" opacity="0.3"/>
                            <circle cx="10" cy="10" r="5" fill="#155724" opacity="0.5"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#habitat)"/>
                </svg>
            `), bounds, {
                opacity: 0.4
            });
            
            imageOverlay.addTo(habitatLayer);
        }

        // Update statistics panel
        function updateStats() {
            const uniqueSpecies = new Set(iNaturalistData.map(obs => obs.taxon_id)).size;
            const totalObservations = iNaturalistData.reduce((sum, species) => sum + species.count, 0);
            
            document.getElementById('stat-inaturalist').textContent = totalObservations;
            document.getElementById('stat-species').textContent = uniqueSpecies;
        }

        // Refresh/filter iNaturalist data based on current settings
        function refreshINaturalistData() {
            if (iNaturalistData.length === 0) {
                showError('No iNaturalist data loaded. Check that data/iNat.geojson exists.');
                return;
            }

            // Apply filters to existing data
            const minObs = document.getElementById('min-obs-filter').value;
            const filteredData = iNaturalistData.filter(species => species.count >= minObs);
            
            console.log(`Filtered to ${filteredData.length} species with at least ${minObs} observations`);
            
            if (document.getElementById('species').checked) {
                updateSpeciesDisplay();
            }
            
            updateStats();
            showSuccess(`Filtered to ${filteredData.length} species meeting criteria`);
        }

        // Event listeners
        function setupEventListeners() {
            // Layer toggles
            document.getElementById('prairies').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(prairieLayer);
                    updatePrairieDisplay();
                } else {
                    map.removeLayer(prairieLayer);
                }
            });

            document.getElementById('connectivity').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(connectivityLayer);
                    updateConnectivityDisplay();
                } else {
                    map.removeLayer(connectivityLayer);
                }
            });

            document.getElementById('species').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(speciesLayer);
                    updateSpeciesDisplay();
                } else {
                    map.removeLayer(speciesLayer);
                }
            });

            document.getElementById('habitat').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(habitatLayer);
                    updateHabitatDisplay();
                } else {
                    map.removeLayer(habitatLayer);
                }
            });

            // Data source toggles
            document.getElementById('show-example').addEventListener('change', function() {
                if (document.getElementById('prairies').checked) {
                    updatePrairieDisplay();
                }
            });

            document.getElementById('show-inaturalist').addEventListener('change', function() {
                if (document.getElementById('species').checked) {
                    updateSpeciesDisplay();
                }
            });

            // Filter controls
            document.getElementById('date-filter').addEventListener('change', function() {
                // Date filter is now informational only since we're using local data
                console.log('Date filter changed to:', this.value, 'months');
            });

            document.getElementById('min-obs-filter').addEventListener('input', function() {
                // Re-filter existing data when minimum observation count changes
                if (document.getElementById('species').checked) {
                    updateSpeciesDisplay();
                    updateStats();
                }
            });

            document.getElementById('taxon-select').addEventListener('change', function() {
                // Taxon filter is now informational only since we're using pre-filtered local data
                console.log('Taxon filter changed to:', this.value);
            });

            // Refresh button
            document.getElementById('refresh-inaturalist').addEventListener('click', function() {
                refreshINaturalistData();
            });

            // Map click handler for debugging
            map.on('click', function(e) {
                console.log('Map clicked at:', e.latlng);
            });
        }

        // Initialize the application
        async function initialize() {
            console.log('Hill Prairie Research Application - iNaturalist Integration');
            
            // Set up initial prairie data
            prairieData = [...examplePrairies];
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize default layers
            map.addLayer(prairieLayer);
            updatePrairieDisplay();
            
            // Load initial iNaturalist data from GeoJSON file
            await loadINaturalistData();
            
            // Add species layer if data was loaded successfully
            if (iNaturalistData.length > 0) {
                map.addLayer(speciesLayer);
                updateSpeciesDisplay();
                updateStats();
            }
            
            console.log('Application initialized successfully');
        }

        // Start the application
        initialize().catch(error => {
            console.error('Failed to initialize application:', error);
            updateApiStatus('error', 'Failed to initialize application. Please refresh the page.');
        });
    </script>
</body>
</html>
